<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentWallet Quest | Earn Your Mainnet Allocation</title>
<meta name="description" content="Complete quests to earn $AW points and secure your mainnet whitelist spot. The agentic economy awaits.">
<meta property="og:title" content="AgentWallet Quest Campaign | Earn $AW Rewards">
<meta property="og:description" content="Complete quests. Earn points. Secure your mainnet allocation. The autonomous agent economy is here.">
<meta property="og:image" content="https://agentwallet.fun/og-image.png">
<meta property="og:url" content="https://agentwallet.fun/quest.html">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="AgentWallet Quest | Earn $AW Mainnet Allocation">
<meta name="twitter:description" content="Terminal-native quests. Complete missions. Earn $AW tokens. Join the agent economy.">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--bg2:#0d0d0d;--g:#00ff41;--c:#00d4ff;--m:#e040fb;--p:#a855f7;--y:#ffcc00;--o:#ff6600;--r:#ff0040;--pk:#ff69b4;--dim:#4a5568;--dimlt:#718096;--glass:rgba(10,10,10,0.9);--gbdr:rgba(255,255,255,0.06)}
html{scroll-behavior:smooth;scrollbar-width:thin;scrollbar-color:#1a3a1a var(--bg)}
body{font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--g);min-height:100vh;font-size:13px;line-height:1.6;overflow-x:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:#1a3a1a;border-radius:3px}
a{color:var(--c);text-decoration:none;transition:all .2s}a:hover{text-shadow:0 0 10px var(--c)}

/* CRT + MATRIX */
#crt{position:fixed;inset:0;pointer-events:none;z-index:9999}
#crt::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.05) 2px,rgba(0,0,0,.05) 4px)}
#crt::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 60%,rgba(0,0,0,.35) 100%)}
#matrix{position:fixed;inset:0;z-index:0;opacity:.04;pointer-events:none}

/* AUTH MODAL */
.auth-overlay{position:fixed;inset:0;z-index:5000;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
.auth-overlay.hidden{display:none}
.auth-box{background:rgba(15,15,15,.95);border:1px solid rgba(0,255,65,.15);padding:40px;width:440px;max-width:92vw;position:relative}
.auth-box h2{text-align:center;color:var(--g);font-size:22px;letter-spacing:4px;margin-bottom:6px;text-shadow:0 0 20px rgba(0,255,65,.3)}
.auth-box .sub{text-align:center;color:var(--dim);font-size:11px;margin-bottom:28px;letter-spacing:1px}
.auth-box label{display:block;font-size:10px;color:var(--dim);letter-spacing:2px;margin-bottom:6px}
.auth-box input{width:100%;background:#000;border:1px solid var(--gbdr);color:var(--g);padding:12px 14px;font-family:inherit;font-size:13px;outline:none;margin-bottom:16px;transition:border .2s}
.auth-box input:focus{border-color:rgba(0,255,65,.3);box-shadow:0 0 10px rgba(0,255,65,.1)}
.auth-box .btn{width:100%;background:rgba(0,255,65,.08);border:1px solid var(--g);color:var(--g);padding:12px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;letter-spacing:2px;transition:all .3s}
.auth-box .btn:hover{background:rgba(0,255,65,.15);box-shadow:0 0 20px rgba(0,255,65,.2)}
.auth-box .btn:disabled{opacity:.4;cursor:not-allowed}
.auth-msg{text-align:center;font-size:11px;margin-top:12px;min-height:16px}
.auth-msg.error{color:var(--r)}.auth-msg.success{color:var(--g)}
.auth-otp-section{display:none}
.auth-otp-section.active{display:block}

/* NAV */
.nav{position:fixed;top:0;width:100%;z-index:1000;backdrop-filter:blur(20px);background:rgba(10,10,10,.85);border-bottom:1px solid rgba(0,255,65,.08);padding:0 20px}
.nav-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;height:48px;gap:12px}
.nav-logo{font-weight:800;font-size:15px;color:var(--g);letter-spacing:2px;text-shadow:0 0 10px rgba(0,255,65,.3)}
.nav-user{color:var(--dim);font-size:10px;margin-left:12px;letter-spacing:1px}
.nav-links{margin-left:auto;display:flex;gap:8px;align-items:center}
.nav-link{color:var(--dim);font-size:11px;padding:5px 12px;letter-spacing:1px;transition:all .3s;border:1px solid transparent}
.nav-link:hover{color:var(--g);border-color:rgba(0,255,65,.15);text-decoration:none}
.sound-toggle{background:none;border:1px solid var(--gbdr);color:var(--dim);font-size:14px;padding:4px 8px;cursor:pointer;font-family:inherit;transition:all .2s}
.sound-toggle:hover{border-color:var(--g);color:var(--g)}
.sound-toggle.on{color:var(--g);border-color:rgba(0,255,65,.3)}

/* MAIN */
.main{position:relative;z-index:2;max-width:900px;margin:0 auto;padding:70px 20px 80px}
.main.blurred{filter:blur(4px);pointer-events:none;user-select:none}

/* HERO */
.hero{text-align:center;padding:50px 0 40px}
.hero-badge{display:inline-block;padding:6px 20px;border:1px solid var(--r);color:var(--r);font-size:11px;letter-spacing:3px;margin-bottom:20px;background:rgba(255,0,64,.03);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.hero h1{font-size:clamp(28px,6vw,56px);font-weight:800;color:var(--g);letter-spacing:4px;text-shadow:0 0 30px rgba(0,255,65,.3),0 0 60px rgba(0,255,65,.1);line-height:1.1;margin-bottom:16px}
.hero h1 span{color:var(--c)}
.hero-sub{font-size:clamp(12px,2vw,15px);color:var(--dimlt);max-width:550px;margin:0 auto 30px;line-height:1.7}
.hero-stats{display:flex;justify-content:center;gap:30px;flex-wrap:wrap}
.hero-stat{text-align:center}
.hero-stat-val{font-size:24px;font-weight:800;color:var(--y);text-shadow:0 0 10px rgba(255,204,0,.3)}
.hero-stat-lbl{font-size:10px;color:var(--dim);letter-spacing:2px;margin-top:2px}

/* LEVEL / XP BAR */
.level-section{background:var(--glass);border:1px solid var(--gbdr);padding:20px 24px;margin:30px 0}
.level-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.level-name{color:var(--m);font-size:14px;font-weight:700;letter-spacing:2px}
.level-pts{color:var(--y);font-weight:700;font-size:16px}
.level-sub{color:var(--dim);font-size:10px;margin-bottom:10px;letter-spacing:1px}
.xp-bar{width:100%;height:8px;background:rgba(255,255,255,.05);border-radius:4px;overflow:hidden;position:relative}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--g),var(--c),var(--m));border-radius:4px;transition:width 1s ease;box-shadow:0 0 10px var(--g)}
.level-tiers{display:flex;justify-content:space-between;margin-top:8px;font-size:9px;color:var(--dim)}
.level-tiers span.reached{color:var(--g);font-weight:700}

/* STREAK */
.streak-section{display:flex;gap:20px;align-items:center;margin:20px 0;padding:16px 20px;background:var(--glass);border:1px solid var(--gbdr);flex-wrap:wrap}
.streak-fire{font-size:32px;position:relative}
.streak-fire .streak-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:14px;font-weight:800;color:var(--bg);text-shadow:0 0 2px rgba(0,0,0,.5)}
.streak-info{flex:1;min-width:200px}
.streak-label{color:var(--o);font-size:12px;font-weight:700;letter-spacing:2px}
.streak-detail{color:var(--dim);font-size:11px;margin-top:2px}
.streak-cal{display:flex;gap:3px;flex-wrap:wrap;margin-top:8px}
.streak-day{width:14px;height:14px;border-radius:2px;background:rgba(255,255,255,.04)}
.streak-day.active{background:var(--g);box-shadow:0 0 4px var(--g)}
.streak-day.today{border:1px solid var(--y)}

/* COMMUNITY GOAL */
.community-goal{margin:20px 0;padding:16px 20px;background:var(--glass);border:1px solid rgba(0,212,255,.1)}
.cg-title{color:var(--c);font-size:11px;letter-spacing:2px;margin-bottom:8px}
.cg-bar{width:100%;height:6px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden}
.cg-fill{height:100%;background:linear-gradient(90deg,var(--c),var(--m));border-radius:3px;transition:width 1s}
.cg-milestones{display:flex;justify-content:space-between;margin-top:6px;font-size:9px;color:var(--dim)}
.cg-milestones span.reached{color:var(--c);font-weight:700}

/* COUNTDOWN */
.countdown{text-align:center;margin:30px 0;padding:24px;border:1px solid rgba(255,0,64,.2);background:rgba(255,0,64,.02)}
.countdown-title{color:var(--r);font-size:11px;letter-spacing:3px;margin-bottom:12px}
.countdown-timer{display:flex;justify-content:center;gap:16px}
.countdown-unit{text-align:center}
.countdown-val{font-size:28px;font-weight:800;color:var(--r);text-shadow:0 0 15px rgba(255,0,64,.3)}
.countdown-lbl{font-size:9px;color:var(--dim);letter-spacing:2px;margin-top:2px}

/* QUEST SECTIONS */
.quest-section{margin-top:40px}
.quest-section-title{font-size:13px;color:var(--dim);letter-spacing:3px;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.quest-section-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(0,255,65,.2),transparent)}
.quest-section-accent{color:var(--m);font-weight:700}

/* QUEST CARDS */
.quest-card{background:var(--glass);border:1px solid var(--gbdr);padding:0;margin-bottom:10px;overflow:hidden;transition:all .3s;position:relative}
.quest-card:hover{border-color:rgba(0,255,65,.15);box-shadow:0 4px 20px rgba(0,0,0,.3)}
.quest-card.completed{border-color:rgba(0,255,65,.15)}
.quest-card.completed .quest-inner{opacity:.65}
.quest-card.completed::after{content:'COMPLETED';position:absolute;top:0;right:0;background:var(--g);color:var(--bg);font-size:9px;padding:3px 10px;letter-spacing:1px;font-weight:700;z-index:2}
.quest-card.pending::after{content:'PENDING REVIEW';position:absolute;top:0;right:0;background:var(--y);color:var(--bg);font-size:9px;padding:3px 10px;letter-spacing:1px;font-weight:700;z-index:2}
.quest-card.locked{opacity:.4;pointer-events:none;position:relative}
.quest-card.locked::before{content:'LOCKED';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--r);font-size:12px;font-weight:700;letter-spacing:2px;z-index:3;text-shadow:0 0 10px var(--r)}
.quest-card.glow-pulse{animation:glowPulse 1s ease}
@keyframes glowPulse{0%{box-shadow:0 0 0 rgba(0,255,65,0)}50%{box-shadow:0 0 30px rgba(0,255,65,.4)}100%{box-shadow:0 0 0 rgba(0,255,65,0)}}
.quest-inner{display:flex;align-items:center;padding:16px 20px;gap:16px;position:relative;z-index:1}
.quest-icon{font-size:24px;flex-shrink:0;width:40px;text-align:center}
.quest-info{flex:1}
.quest-name{font-weight:700;color:var(--g);font-size:13px;letter-spacing:1px;margin-bottom:2px}
.quest-desc{color:var(--dim);font-size:11px;line-height:1.5}
.quest-prereq{color:var(--r);font-size:9px;letter-spacing:1px;margin-top:3px}
.quest-reward{flex-shrink:0;text-align:right}
.quest-pts{color:var(--y);font-weight:800;font-size:16px}
.quest-pts-label{color:var(--dim);font-size:9px;letter-spacing:1px}
.quest-btn{flex-shrink:0}
.quest-btn button{background:rgba(0,212,255,.08);border:1px solid var(--c);color:var(--c);padding:8px 20px;font-family:inherit;font-size:11px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all .3s}
.quest-btn button:hover{background:rgba(0,212,255,.15);box-shadow:0 0 15px rgba(0,212,255,.2);transform:translateY(-1px)}
.quest-btn button.done{border-color:var(--g);color:var(--g);background:rgba(0,255,65,.05);cursor:default}
.quest-btn button:disabled{opacity:.4;cursor:not-allowed}
.quest-btn button.counting{border-color:var(--y);color:var(--y);background:rgba(255,204,0,.05)}

/* QUEST EXPAND AREAS */
.quest-expand{padding:0 20px 16px;display:none}
.quest-expand.open{display:block}
.quest-expand input,.quest-expand textarea{width:100%;background:#000;border:1px solid var(--gbdr);color:var(--g);padding:10px 14px;font-family:inherit;font-size:12px;outline:none;margin-bottom:8px;transition:border .2s}
.quest-expand input:focus,.quest-expand textarea:focus{border-color:rgba(0,255,65,.3)}
.quest-expand .actions{display:flex;gap:8px;flex-wrap:wrap}
.quest-expand .actions button{background:rgba(0,212,255,.08);border:1px solid var(--c);color:var(--c);padding:6px 16px;font-family:inherit;font-size:11px;cursor:pointer;transition:all .3s;font-weight:700}
.quest-expand .actions button:hover{background:rgba(0,212,255,.15);box-shadow:0 0 10px rgba(0,212,255,.2)}
.quest-expand .actions button.primary{background:var(--c);color:var(--bg);border-color:var(--c)}

/* TWEET PREVIEW */
.tweet-preview{background:#000;border:1px solid var(--gbdr);padding:14px;font-size:12px;color:var(--dimlt);line-height:1.7;margin-bottom:10px}
.tweet-preview .hl{color:var(--c)}.tweet-preview .tag{color:var(--m)}

/* QUIZ MODAL */
.quiz-modal{position:fixed;inset:0;z-index:4000;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.quiz-modal.open{display:flex}
.quiz-box{background:rgba(15,15,15,.95);border:1px solid rgba(0,212,255,.2);padding:32px;width:600px;max-width:92vw;max-height:80vh;overflow-y:auto}
.quiz-box h3{color:var(--c);font-size:16px;letter-spacing:2px;margin-bottom:20px}
.quiz-q{margin-bottom:20px}
.quiz-q .q-text{color:var(--g);font-size:12px;margin-bottom:8px}
.quiz-q .q-opt{display:block;padding:8px 12px;margin:4px 0;background:rgba(255,255,255,.02);border:1px solid var(--gbdr);color:var(--dimlt);font-size:11px;cursor:pointer;transition:all .2s;font-family:inherit;width:100%;text-align:left}
.quiz-q .q-opt:hover{border-color:var(--c);color:var(--c)}
.quiz-q .q-opt.selected{border-color:var(--c);color:var(--c);background:rgba(0,212,255,.08)}
.quiz-submit{background:var(--c);color:var(--bg);border:none;padding:10px 30px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:1px;margin-top:10px}
.quiz-close{background:none;border:1px solid var(--dim);color:var(--dim);padding:8px 20px;font-family:inherit;font-size:11px;cursor:pointer;margin-left:10px}

/* TYPING CHALLENGE */
.typing-area{margin-top:10px}
.typing-target{background:#000;border:1px solid var(--gbdr);padding:14px;font-size:12px;color:var(--dimlt);line-height:1.8;margin-bottom:8px;user-select:none}
.typing-input{width:100%;background:#000;border:1px solid var(--gbdr);color:var(--g);padding:14px;font-family:inherit;font-size:12px;outline:none;resize:none;min-height:80px}
.typing-stats{display:flex;gap:20px;font-size:11px;color:var(--dim);margin-top:6px}
.typing-stats span{color:var(--c)}

/* ACHIEVEMENTS */
.achievements-grid{display:flex;gap:10px;flex-wrap:wrap;margin:20px 0}
.achievement-badge{width:70px;height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid var(--gbdr);background:rgba(255,255,255,.02);transition:all .3s;position:relative}
.achievement-badge.unlocked{border-color:var(--y);background:rgba(255,204,0,.05);box-shadow:0 0 10px rgba(255,204,0,.1)}
.achievement-badge .badge-icon{font-size:22px;margin-bottom:2px}
.achievement-badge .badge-name{font-size:7px;color:var(--dim);letter-spacing:1px;text-align:center;line-height:1.2}
.achievement-badge.unlocked .badge-name{color:var(--y)}
.achievement-badge:not(.unlocked){opacity:.35;filter:grayscale(1)}

/* ACTIVITY FEED */
.feed-section{margin:30px 0;padding:16px 20px;background:var(--glass);border:1px solid var(--gbdr);max-height:240px;overflow-y:auto}
.feed-title{color:var(--g);font-size:11px;letter-spacing:2px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.feed-dot{width:6px;height:6px;border-radius:50%;background:var(--g);animation:pulse 1.5s infinite}
.feed-item{padding:6px 0;border-bottom:1px solid var(--gbdr);font-size:11px;color:var(--dimlt);display:flex;justify-content:space-between}
.feed-item:last-child{border:none}
.feed-item .feed-pts{color:var(--y);font-weight:700}
.feed-item .feed-time{color:var(--dim);font-size:9px}

/* REFERRAL */
.referral-box{background:var(--glass);border:2px solid var(--m);padding:24px;margin-top:40px;text-align:center;position:relative;overflow:hidden}
.referral-box::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(224,64,251,.03),transparent);pointer-events:none}
.referral-title{color:var(--m);font-size:16px;font-weight:800;letter-spacing:3px;margin-bottom:8px;text-shadow:0 0 20px rgba(224,64,251,.3)}
.referral-sub{color:var(--dim);font-size:12px;margin-bottom:16px}
.referral-link{display:flex;gap:8px;max-width:500px;margin:0 auto}
.referral-link input{flex:1;background:#000;border:1px solid rgba(224,64,251,.2);color:var(--m);padding:10px 14px;font-family:inherit;font-size:12px;outline:none}
.referral-link button{background:var(--m);color:var(--bg);border:none;padding:10px 20px;font-family:inherit;font-weight:700;cursor:pointer;font-size:12px;letter-spacing:1px;transition:all .3s}
.referral-link button:hover{box-shadow:0 0 15px rgba(224,64,251,.3)}
.referral-stats{display:flex;justify-content:center;gap:40px;margin-top:16px}
.referral-stat{text-align:center}
.referral-stat-val{color:var(--m);font-size:20px;font-weight:800}
.referral-stat-lbl{color:var(--dim);font-size:10px;letter-spacing:1px}

/* LEADERBOARD */
.leaderboard{margin-top:40px}
.lb-title{color:var(--y);font-size:14px;font-weight:700;letter-spacing:2px;margin-bottom:16px;text-shadow:0 0 10px rgba(255,204,0,.2)}
.lb-table{width:100%;border-collapse:collapse}
.lb-table th{text-align:left;padding:8px 12px;color:var(--dim);border-bottom:1px solid rgba(255,204,0,.1);font-size:10px;letter-spacing:2px}
.lb-table td{padding:8px 12px;border-bottom:1px solid var(--gbdr);font-size:12px;color:var(--dimlt)}
.lb-table tr:hover td{background:rgba(255,204,0,.02);color:var(--y)}
.lb-rank{color:var(--y);font-weight:700;width:40px}
.lb-you{background:rgba(0,255,65,.03)!important}
.lb-you td{color:var(--g)!important;font-weight:700}

/* REWARD TIERS */
.tiers{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:40px}
.tier{background:var(--glass);border:1px solid var(--gbdr);padding:20px;text-align:center;transition:all .3s;position:relative}
.tier:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.3)}
.tier-name{font-size:11px;color:var(--dim);letter-spacing:2px;margin-bottom:6px}
.tier-pts{font-size:22px;font-weight:800;margin-bottom:4px}
.tier-reward{font-size:11px;color:var(--dimlt);line-height:1.6}
.tier.bronze{border-top:2px solid #cd7f32}.tier.bronze .tier-pts{color:#cd7f32}
.tier.silver{border-top:2px solid #c0c0c0}.tier.silver .tier-pts{color:#c0c0c0}
.tier.gold{border-top:2px solid var(--y)}.tier.gold .tier-pts{color:var(--y)}
.tier.diamond{border-top:2px solid var(--c);box-shadow:0 0 15px rgba(0,212,255,.1)}.tier.diamond .tier-pts{color:var(--c)}

/* FOOTER */
.footer{margin-top:60px;padding:30px 0;border-top:1px solid var(--gbdr);text-align:center}
.footer-links{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.footer-link{color:var(--dim);font-size:12px;padding:4px 12px;border:1px solid var(--gbdr);transition:all .3s}
.footer-link:hover{border-color:var(--g);color:var(--g);text-decoration:none}
.footer-copy{color:rgba(255,255,255,.1);font-size:11px}

/* CONFETTI */
.confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:8000;overflow:hidden}
.confetti-piece{position:absolute;width:8px;height:8px;top:-10px;animation:confettiFall 3s ease-out forwards}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}

/* COUNTER ANIM */
.counter-animate{transition:none}

@media(max-width:768px){.quest-inner{flex-direction:column;align-items:flex-start;gap:10px}.quest-reward{text-align:left}.tiers{grid-template-columns:repeat(2,1fr)}.hero-stats{gap:16px}.referral-link{flex-direction:column}.countdown-timer{gap:10px}.countdown-val{font-size:22px}.achievements-grid{justify-content:center}.streak-section{flex-direction:column;text-align:center}}
@media(max-width:480px){.tiers{grid-template-columns:1fr}.nav-link:not(:first-child){display:none}}

/* ENHANCED HACKER EFFECTS */
#particles{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.25}
.grid-overlay{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(0,255,65,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,65,.02) 1px,transparent 1px);background-size:60px 60px}
#scroll-prog{position:fixed;top:0;left:0;height:3px;z-index:10001;background:linear-gradient(90deg,#00ff41,#00d4ff,#e040fb,#a855f7,#ffcc00);width:0;transition:width .15s}
body{animation:flk 10s infinite}
@keyframes flk{0%,100%{opacity:1}92%{opacity:1}93%{opacity:.85}94%{opacity:1}96%{opacity:.92}97%{opacity:1}}
.hero h1{position:relative}
.hero h1::before,.hero h1::after{content:'AGENTQUEST';position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden}
.hero h1::before{color:var(--c);z-index:-1;animation:g1 3s infinite linear alternate-reverse;clip-path:inset(0 0 65% 0)}
.hero h1::after{color:var(--m);z-index:-2;animation:g2 2.5s infinite linear alternate-reverse;clip-path:inset(40% 0 0 0)}
@keyframes g1{0%,100%{transform:translate(0)}20%{transform:translate(-3px,2px)}40%{transform:translate(3px,-1px)}60%{transform:translate(-2px,1px)}80%{transform:translate(2px,-2px)}}
@keyframes g2{0%,100%{transform:translate(0)}20%{transform:translate(2px,-2px)}40%{transform:translate(-3px,1px)}60%{transform:translate(3px,2px)}80%{transform:translate(-1px,-1px)}}
@keyframes gsk{0%,100%{transform:skew(0)}31%{transform:skew(.4deg)}32%{transform:skew(0)}69%{transform:skew(-.3deg)}70%{transform:skew(0)}}
.hero h1{animation:gsk 4s infinite linear alternate-reverse}
.quest-card{position:relative;overflow:hidden}
.quest-card::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--g),transparent);animation:scanCard 4s linear infinite;z-index:3}
@keyframes scanCard{0%{left:-100%}100%{left:100%}}
.quest-card:hover{box-shadow:0 0 25px rgba(0,255,65,.1)}
.nav-logo{text-shadow:0 0 15px rgba(0,255,65,.5),0 0 40px rgba(0,255,65,.2)}
.auth-box h2{text-shadow:0 0 30px rgba(0,255,65,.4),0 0 60px rgba(0,255,65,.15)}
.tier{position:relative;overflow:hidden}
.tier::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);animation:scanCard 5s linear infinite}
.lb-table tr{transition:all .2s}
.lb-table tr:hover td{text-shadow:0 0 8px rgba(255,204,0,.2)}
.referral-box::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--m),transparent);animation:scanCard 3s linear infinite}
.quest-section-title{text-shadow:0 0 10px rgba(224,64,251,.2)}
.countdown-val{text-shadow:0 0 20px rgba(255,0,64,.4),0 0 40px rgba(255,0,64,.2)}
.level-section{position:relative;overflow:hidden}
.level-section::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--m),transparent);animation:scanCard 4s linear infinite}
.streak-section{position:relative;overflow:hidden}
.streak-section::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--o),transparent);animation:scanCard 4.5s linear infinite}
.feed-section{position:relative;overflow:hidden}
.feed-section::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--g),transparent);animation:scanCard 3.5s linear infinite}
@keyframes tGlitch{0%,100%{opacity:1;transform:translate(0)}33%{opacity:.8;transform:translate(-2px,1px);filter:hue-rotate(90deg)}66%{opacity:.9;transform:translate(1px,-1px)}}
.quest-btn button{position:relative;overflow:hidden}
.quest-btn button::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,212,255,.1),transparent);transition:left .5s}
.quest-btn button:hover::before{left:100%}
</style>
</head>
<body>
<div id="crt"></div>
<canvas id="matrix"></canvas>
<canvas id="particles"></canvas>
<div class="grid-overlay"></div>
<div id="scroll-prog"></div>

<!-- AUTH OVERLAY -->
<div class="auth-overlay" id="auth-overlay">
<div class="auth-box">
<h2>AGENT<span style="color:var(--c)">QUEST</span></h2>
<div class="sub">// AUTHENTICATE TO BEGIN MISSIONS</div>
<div id="auth-email-section">
<label>EMAIL ADDRESS</label>
<input type="email" id="auth-email" placeholder="agent@protocol.io">
<button class="btn" id="auth-send-btn" onclick="sendMagicLink()">SEND MAGIC LINK</button>
</div>
<div class="auth-otp-section" id="auth-otp-section">
<label>ENTER OTP CODE</label>
<input type="text" id="auth-otp" placeholder="000000" maxlength="6">
<button class="btn" id="auth-verify-btn" onclick="verifyOtp()">VERIFY &amp; ENTER</button>
</div>
<div class="auth-msg" id="auth-msg"></div>
</div>
</div>

<nav class="nav"><div class="nav-inner">
<div class="nav-logo">AW QUEST</div>
<span class="nav-user" id="nav-user"></span>
<div class="nav-links">
<button class="sound-toggle" id="sound-toggle" onclick="toggleSound()" title="Toggle sounds">&#9834;</button>
<a href="index.html" class="nav-link">[Home]</a>
<a href="dashboard.html" class="nav-link">[Dashboard]</a>
<a href="docs.html" class="nav-link">[Docs]</a>
<a id="logout-link" class="nav-link" style="cursor:pointer;display:none" onclick="doLogout()">[Logout]</a>
</div>
</div></nav>

<div class="main" id="main-content">

<section class="hero">
<div class="hero-badge">CAMPAIGN ACTIVE</div>
<h1>AGENT<span>QUEST</span></h1>
<p class="hero-sub">Complete missions. Earn $AW points. Secure your mainnet allocation. The autonomous agent economy rewards its earliest believers.</p>
<div class="hero-stats">
<div class="hero-stat"><div class="hero-stat-val" id="total-participants">0</div><div class="hero-stat-lbl">AGENTS ENLISTED</div></div>
<div class="hero-stat"><div class="hero-stat-val">1,000,000</div><div class="hero-stat-lbl">$AW REWARD POOL</div></div>
<div class="hero-stat"><div class="hero-stat-val" id="total-quests">14</div><div class="hero-stat-lbl">ACTIVE QUESTS</div></div>
</div>
</section>

<!-- COUNTDOWN -->
<div class="countdown">
<div class="countdown-title">CAMPAIGN ENDS IN</div>
<div class="countdown-timer">
<div class="countdown-unit"><div class="countdown-val" id="cd-days">--</div><div class="countdown-lbl">DAYS</div></div>
<div class="countdown-unit"><div class="countdown-val" id="cd-hours">--</div><div class="countdown-lbl">HOURS</div></div>
<div class="countdown-unit"><div class="countdown-val" id="cd-mins">--</div><div class="countdown-lbl">MINUTES</div></div>
<div class="countdown-unit"><div class="countdown-val" id="cd-secs">--</div><div class="countdown-lbl">SECONDS</div></div>
</div>
</div>

<!-- LEVEL / XP -->
<div class="level-section">
<div class="level-header">
<span class="level-name" id="level-name">RECRUIT</span>
<span class="level-pts"><span id="user-pts">0</span> PTS</span>
</div>
<div class="level-sub" id="level-sub">0 / 100 to next level</div>
<div class="xp-bar"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
<div class="level-tiers">
<span>Recruit</span><span>Initiate</span><span>Operative</span><span>Agent</span><span>Commander</span><span>Elite</span><span>Phantom</span><span>Sovereign</span>
</div>
</div>

<!-- STREAK -->
<div class="streak-section" id="streak-section">
<div class="streak-fire" id="streak-fire">&#128293;<span class="streak-num" id="streak-num">0</span></div>
<div class="streak-info">
<div class="streak-label">DAILY STREAK</div>
<div class="streak-detail" id="streak-detail">Check in daily to build your streak</div>
<div class="streak-cal" id="streak-cal"></div>
</div>
</div>

<!-- COMMUNITY GOAL -->
<div class="community-goal">
<div class="cg-title">COMMUNITY GOAL &mdash; COLLECTIVE POINTS</div>
<div class="cg-bar"><div class="cg-fill" id="cg-fill" style="width:0%"></div></div>
<div class="cg-milestones">
<span id="cg-10k">10K</span>
<span id="cg-50k">50K</span>
<span id="cg-100k">100K</span>
</div>
</div>

<!-- ACHIEVEMENTS -->
<div class="quest-section">
<div class="quest-section-title"><span class="quest-section-accent">&#9733;</span> ACHIEVEMENTS</div>
</div>
<div class="achievements-grid" id="achievements-grid"></div>

<!-- DAILY QUEST -->
<div class="quest-section">
<div class="quest-section-title"><span class="quest-section-accent">&#10004;</span> DAILY</div>
</div>

<div class="quest-card" id="card-daily-checkin" data-quest="daily-checkin" data-pts="50">
<div class="quest-inner">
<div class="quest-icon">&#128197;</div>
<div class="quest-info"><div class="quest-name">Daily Check-in</div><div class="quest-desc">Check in daily to earn points. Streak bonuses at 3/7/14/30 days!</div></div>
<div class="quest-reward"><div class="quest-pts">+50</div><div class="quest-pts-label">$AW PTS/DAY</div></div>
<div class="quest-btn"><button onclick="doDailyCheckin()">CHECK IN</button></div>
</div></div>

<!-- SOCIAL QUESTS -->
<div class="quest-section">
<div class="quest-section-title"><span class="quest-section-accent">01</span> SOCIAL MISSIONS</div>
</div>

<div class="quest-card" id="card-follow-twitter" data-quest="follow-twitter" data-pts="200">
<div class="quest-inner">
<div class="quest-icon">&#120143;</div>
<div class="quest-info"><div class="quest-name">Follow @Web3__Youth</div><div class="quest-desc">Follow the official AgentWallet builder on X</div></div>
<div class="quest-reward"><div class="quest-pts">+200</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="startQuest('follow-twitter','https://twitter.com/intent/follow?screen_name=Web3__Youth')">EXECUTE</button></div>
</div></div>

<div class="quest-card" id="card-follow-aw" data-quest="follow-aw" data-pts="200">
<div class="quest-inner">
<div class="quest-icon">&#120143;</div>
<div class="quest-info"><div class="quest-name">Follow @agentwallet_pro</div><div class="quest-desc">Follow the official AgentWallet protocol account</div><div class="quest-prereq" id="prereq-follow-aw"></div></div>
<div class="quest-reward"><div class="quest-pts">+200</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="startQuest('follow-aw','https://twitter.com/intent/follow?screen_name=agentwallet_pro')">EXECUTE</button></div>
</div></div>

<div class="quest-card" id="card-tweet-about" data-quest="tweet-about" data-pts="500">
<div class="quest-inner">
<div class="quest-icon">&#128226;</div>
<div class="quest-info"><div class="quest-name">Tweet About AgentWallet</div><div class="quest-desc">Share your excitement about the protocol. Paste tweet URL as proof.</div><div class="quest-prereq" id="prereq-tweet-about"></div></div>
<div class="quest-reward"><div class="quest-pts">+500</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="toggleExpand('tweet-about')">COMPOSE</button></div>
</div>
<div class="quest-expand" id="expand-tweet-about">
<div class="tweet-preview">
Just discovered <span class="hl">@agentwallet_pro</span> — the financial infrastructure for autonomous AI agents on <span class="hl">@solana</span> &#129302;<br><br>
Trustless escrow, spending limits, 27 MCP tools, x402 payments. This is how agents become economic actors.<br><br>
Joining the beta quest &rarr; <span class="hl">agentwallet.fun/quest.html</span><br><br>
<span class="tag">#AgentWallet #Solana #AI #MCP #web3</span>
</div>
<input type="text" id="proof-tweet-about" placeholder="Paste your tweet URL here...">
<div class="actions">
<button class="primary" onclick="openTweetComposer()">OPEN X TO POST</button>
<button onclick="submitProofQuest('tweet-about')">SUBMIT PROOF</button>
</div>
</div></div>

<div class="quest-card" id="card-like-retweet" data-quest="like-retweet" data-pts="300">
<div class="quest-inner">
<div class="quest-icon">&#128260;</div>
<div class="quest-info"><div class="quest-name">Like &amp; Retweet Pinned Post</div><div class="quest-desc">Engage with our latest announcement tweet</div><div class="quest-prereq" id="prereq-like-retweet"></div></div>
<div class="quest-reward"><div class="quest-pts">+300</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="startQuest('like-retweet','https://twitter.com/Web3__Youth')">EXECUTE</button></div>
</div></div>

<div class="quest-card" id="card-thread" data-quest="thread" data-pts="1000">
<div class="quest-inner">
<div class="quest-icon">&#129525;</div>
<div class="quest-info"><div class="quest-name">Write a Thread (3+ tweets)</div><div class="quest-desc">Write a thread explaining AgentWallet. Paste thread URL as proof.</div><div class="quest-prereq" id="prereq-thread"></div></div>
<div class="quest-reward"><div class="quest-pts">+1,000</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="toggleExpand('thread')">COMPOSE</button></div>
</div>
<div class="quest-expand" id="expand-thread">
<input type="text" id="proof-thread" placeholder="Paste your thread URL here...">
<div class="actions">
<button class="primary" onclick="submitProofQuest('thread')">SUBMIT PROOF</button>
</div>
</div></div>

<div class="quest-card" id="card-content-creation" data-quest="content-creation" data-pts="750">
<div class="quest-inner">
<div class="quest-icon">&#127908;</div>
<div class="quest-info"><div class="quest-name">Content Creation</div><div class="quest-desc">Create a blog post or video about AgentWallet. Submit URL for review.</div><div class="quest-prereq" id="prereq-content-creation"></div></div>
<div class="quest-reward"><div class="quest-pts">+750</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="toggleExpand('content-creation')">SUBMIT</button></div>
</div>
<div class="quest-expand" id="expand-content-creation">
<input type="text" id="proof-content-creation" placeholder="Paste your blog/video URL here...">
<div class="actions">
<button class="primary" onclick="submitProofQuest('content-creation')">SUBMIT PROOF</button>
</div>
</div></div>

<!-- COMMUNITY QUESTS -->
<div class="quest-section">
<div class="quest-section-title"><span class="quest-section-accent">02</span> COMMUNITY MISSIONS</div>
</div>

<div class="quest-card" id="card-join-whitelist" data-quest="join-whitelist" data-pts="300">
<div class="quest-inner">
<div class="quest-icon">&#128221;</div>
<div class="quest-info"><div class="quest-name">Join Mainnet Whitelist</div><div class="quest-desc">Register your Solana wallet for the mainnet beta</div></div>
<div class="quest-reward"><div class="quest-pts">+300</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="startQuest('join-whitelist','index.html#sec-whitelist')">EXECUTE</button></div>
</div></div>

<div class="quest-card" id="card-star-github" data-quest="star-github" data-pts="400">
<div class="quest-inner">
<div class="quest-icon">&#11088;</div>
<div class="quest-info"><div class="quest-name">Star GitHub Repository</div><div class="quest-desc">Star the open-source AgentWallet repo on GitHub</div></div>
<div class="quest-reward"><div class="quest-pts">+400</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="startQuest('star-github','https://github.com/YouthAIAgent/agentwallet')">EXECUTE</button></div>
</div></div>

<div class="quest-card" id="card-typing-challenge" data-quest="typing-challenge" data-pts="300">
<div class="quest-inner">
<div class="quest-icon">&#9000;</div>
<div class="quest-info"><div class="quest-name">Speed Typing Challenge</div><div class="quest-desc">Type a paragraph about AgentWallet accurately and quickly</div></div>
<div class="quest-reward"><div class="quest-pts">+300</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="toggleExpand('typing-challenge')">START</button></div>
</div>
<div class="quest-expand" id="expand-typing-challenge">
<div class="typing-area">
<div class="typing-target" id="typing-target">AgentWallet is the financial infrastructure for autonomous AI agents on Solana. It provides trustless escrow, spending policies, and 27 MCP tools for agent-to-agent commerce.</div>
<textarea class="typing-input" id="typing-input" placeholder="Start typing the text above..." oninput="checkTyping()"></textarea>
<div class="typing-stats">
<div>Accuracy: <span id="typing-accuracy">0%</span></div>
<div>WPM: <span id="typing-wpm">0</span></div>
<div>Time: <span id="typing-time">0s</span></div>
</div>
<div class="actions" style="margin-top:8px">
<button class="primary" onclick="submitTyping()">SUBMIT</button>
<button onclick="resetTyping()">RESET</button>
</div>
</div>
</div></div>

<!-- BUILDER QUESTS -->
<div class="quest-section">
<div class="quest-section-title"><span class="quest-section-accent">03</span> BUILDER MISSIONS</div>
</div>

<div class="quest-card" id="card-read-docs" data-quest="read-docs" data-pts="200">
<div class="quest-inner">
<div class="quest-icon">&#128214;</div>
<div class="quest-info"><div class="quest-name">Read the API Docs</div><div class="quest-desc">Scroll 75%+ of docs page and spend 60s+ reading</div></div>
<div class="quest-reward"><div class="quest-pts">+200</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="startQuest('read-docs','docs.html')">EXECUTE</button></div>
</div></div>

<div class="quest-card" id="card-try-dashboard" data-quest="try-dashboard" data-pts="500">
<div class="quest-inner">
<div class="quest-icon">&#128421;</div>
<div class="quest-info"><div class="quest-name">Try the Dashboard</div><div class="quest-desc">Register and login on the live dashboard</div></div>
<div class="quest-reward"><div class="quest-pts">+500</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="startQuest('try-dashboard','dashboard.html')">EXECUTE</button></div>
</div></div>

<div class="quest-card" id="card-install-sdk" data-quest="install-sdk" data-pts="500">
<div class="quest-inner">
<div class="quest-icon">&#128230;</div>
<div class="quest-info"><div class="quest-name">Install the Python SDK</div><div class="quest-desc">Run: pip install aw-protocol-sdk — paste pip show output</div><div class="quest-prereq" id="prereq-install-sdk"></div></div>
<div class="quest-reward"><div class="quest-pts">+500</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="toggleExpand('install-sdk')">VERIFY</button></div>
</div>
<div class="quest-expand" id="expand-install-sdk">
<textarea id="proof-install-sdk" rows="4" placeholder="Paste output of 'pip show aw-protocol-sdk' here..."></textarea>
<div class="actions">
<button class="primary" onclick="submitProofQuest('install-sdk')">SUBMIT PROOF</button>
</div>
</div></div>

<div class="quest-card" id="card-knowledge-quiz" data-quest="knowledge-quiz" data-pts="400">
<div class="quest-inner">
<div class="quest-icon">&#129504;</div>
<div class="quest-info"><div class="quest-name">Knowledge Quiz</div><div class="quest-desc">5 random questions about AgentWallet. Score 4/5 to pass.</div><div class="quest-prereq" id="prereq-knowledge-quiz"></div></div>
<div class="quest-reward"><div class="quest-pts">+400</div><div class="quest-pts-label">$AW PTS</div></div>
<div class="quest-btn"><button onclick="openQuiz()">START QUIZ</button></div>
</div></div>

<!-- REFERRAL -->
<div class="referral-box">
<div class="referral-title">REFERRAL PROGRAM</div>
<div class="referral-sub">Earn <span style="color:var(--y);font-weight:700">+200 $AW PTS</span> for every agent you refer. No limits.</div>
<div class="referral-link">
<input type="text" id="ref-link" value="" readonly>
<button onclick="copyRef()">COPY</button>
</div>
<div class="referral-stats">
<div class="referral-stat"><div class="referral-stat-val" id="ref-count">0</div><div class="referral-stat-lbl">REFERRALS</div></div>
<div class="referral-stat"><div class="referral-stat-val" id="ref-pts">0</div><div class="referral-stat-lbl">BONUS PTS</div></div>
</div>
</div>

<!-- REWARD TIERS -->
<div class="quest-section">
<div class="quest-section-title"><span class="quest-section-accent">04</span> REWARD TIERS</div>
</div>
<div class="tiers">
<div class="tier bronze"><div class="tier-name">BRONZE</div><div class="tier-pts">500+</div><div class="tier-reward">100 $AW tokens<br>Beta Tester badge</div></div>
<div class="tier silver"><div class="tier-name">SILVER</div><div class="tier-pts">1,500+</div><div class="tier-reward">300 $AW tokens<br>Priority access<br>Silver NFT</div></div>
<div class="tier gold"><div class="tier-name">GOLD</div><div class="tier-pts">3,000+</div><div class="tier-reward">750 $AW tokens<br>Early mainnet<br>Gold NFT + OG role</div></div>
<div class="tier diamond"><div class="tier-name">DIAMOND</div><div class="tier-pts">5,000+</div><div class="tier-reward">2,000 $AW tokens<br>Founding member<br>Diamond NFT + governance</div></div>
</div>

<!-- LEADERBOARD -->
<div class="leaderboard">
<div class="lb-title">TOP AGENTS LEADERBOARD</div>
<table class="lb-table">
<tr><th>#</th><th>AGENT</th><th>PTS</th><th>TIER</th></tr>
<tbody id="lb-body">
<tr><td colspan="4" style="color:var(--dim);text-align:center;padding:20px">Loading...</td></tr>
</tbody>
</table>
</div>

<!-- ACTIVITY FEED -->
<div class="feed-section" id="feed-section">
<div class="feed-title"><span class="feed-dot"></span> LIVE ACTIVITY FEED</div>
<div id="feed-list"></div>
</div>

<footer class="footer">
<div class="footer-links">
<a href="index.html" class="footer-link">[Home]</a>
<a href="https://github.com/YouthAIAgent/agentwallet" class="footer-link" target="_blank">[GitHub]</a>
<a href="https://twitter.com/Web3__Youth" class="footer-link" target="_blank">[Twitter]</a>
<a href="dashboard.html" class="footer-link">[Dashboard]</a>
<a href="docs.html" class="footer-link">[Docs]</a>
</div>
<div class="footer-copy">AgentWallet Protocol 2026 | Quest Campaign</div>
</footer>

</div>

<!-- QUIZ MODAL -->
<div class="quiz-modal" id="quiz-modal">
<div class="quiz-box">
<h3>KNOWLEDGE QUIZ</h3>
<div id="quiz-questions"></div>
<div style="margin-top:16px">
<button class="quiz-submit" onclick="submitQuiz()">SUBMIT ANSWERS</button>
<button class="quiz-close" onclick="closeQuiz()">CANCEL</button>
</div>
<div id="quiz-result" style="margin-top:12px;font-size:12px"></div>
</div>
</div>

<!-- CONFETTI CONTAINER -->
<div class="confetti-container" id="confetti-container"></div>

<!-- LEVEL UP CANVAS -->
<canvas id="particle-canvas" style="position:fixed;inset:0;z-index:7000;pointer-events:none;display:none"></canvas>

<script>
(function(){'use strict';

// ========== SUPABASE INIT ==========
const SUPABASE_URL = 'https://rlajsbxsculwamkpgsmm.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsYWpzYnhzY3Vsd2Fta3Bnc21tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5NDUwNTUsImV4cCI6MjA4NjUyMTA1NX0.3C0AxpkvFBfGsbYZQYHDE25DY4UgVPMur4c6zK5Lu7A';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
let currentUser = null;
let userProfile = null;
let questDefs = {};
let completedQuests = {};
let quizQuestions = [];
let selectedQuizQuestions = [];
let quizAnswers = {};
let typingStartTime = null;
let soundEnabled = localStorage.getItem('aw_sound') !== 'off';

// ========== MATRIX RAIN ==========
const mc = document.getElementById('matrix'), mx = mc.getContext('2d');
function resM(){mc.width=innerWidth;mc.height=innerHeight}resM();addEventListener('resize',resM);
const ch='01ABCDEF$@#';const fz=14;let co=Math.floor(mc.width/fz),dr=Array(co).fill(1);
setInterval(()=>{mx.fillStyle='rgba(10,10,10,0.04)';mx.fillRect(0,0,mc.width,mc.height);mx.font=fz+'px monospace';mx.fillStyle='#00ff41';for(let i=0;i<dr.length;i++){mx.fillText(ch[Math.floor(Math.random()*ch.length)],i*fz,dr[i]*fz);if(dr[i]*fz>mc.height&&Math.random()>.975)dr[i]=0;dr[i]++}},35);

// ========== SOUND EFFECTS (Web Audio API) ==========
let audioCtx = null;
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}

function playTone(freq, duration, type='sine'){
  if(!soundEnabled)return;
  try{
    const ctx=getAudioCtx();const o=ctx.createOscillator();const g=ctx.createGain();
    o.type=type;o.frequency.value=freq;g.gain.value=0.08;
    o.connect(g);g.connect(ctx.destination);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+duration);
    o.start(ctx.currentTime);o.stop(ctx.currentTime+duration);
  }catch(e){}
}

function soundQuestComplete(){playTone(523,.1);setTimeout(()=>playTone(659,.1),100);setTimeout(()=>playTone(784,.15),200)}
function soundLevelUp(){playTone(523,.15);setTimeout(()=>playTone(659,.15),150);setTimeout(()=>playTone(784,.25),300)}
function soundAchievement(){playTone(880,.12);setTimeout(()=>playTone(1047,.18),120)}
function soundCheckin(){playTone(440,.08,'triangle')}

window.toggleSound=function(){
  soundEnabled=!soundEnabled;
  localStorage.setItem('aw_sound',soundEnabled?'on':'off');
  const btn=document.getElementById('sound-toggle');
  btn.classList.toggle('on',soundEnabled);
  if(soundEnabled)playTone(660,.1);
};
document.getElementById('sound-toggle').classList.toggle('on',soundEnabled);

// ========== CONFETTI ==========
function showConfetti(){
  const container=document.getElementById('confetti-container');
  const colors=['#00ff41','#00d4ff','#e040fb','#ffcc00','#ff6600','#ff0040','#a855f7'];
  for(let i=0;i<30;i++){
    const piece=document.createElement('div');
    piece.className='confetti-piece';
    piece.style.left=Math.random()*100+'%';
    piece.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
    piece.style.animationDelay=Math.random()*0.5+'s';
    piece.style.animationDuration=(2+Math.random()*2)+'s';
    piece.style.width=(6+Math.random()*6)+'px';
    piece.style.height=(6+Math.random()*6)+'px';
    piece.style.borderRadius=Math.random()>0.5?'50%':'0';
    container.appendChild(piece);
    setTimeout(()=>piece.remove(),4000);
  }
}

// ========== PARTICLE BURST (Level Up) ==========
function particleBurst(){
  const canvas=document.getElementById('particle-canvas');
  canvas.style.display='block';
  canvas.width=innerWidth;canvas.height=innerHeight;
  const ctx=canvas.getContext('2d');
  const particles=[];const cx=innerWidth/2,cy=innerHeight/2;
  for(let i=0;i<60;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=2+Math.random()*6;
    particles.push({x:cx,y:cy,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:1,color:['#00ff41','#00d4ff','#e040fb','#ffcc00'][Math.floor(Math.random()*4)]});
  }
  let frame=0;
  function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life-=0.015;p.vy+=0.05;
      if(p.life>0){ctx.beginPath();ctx.arc(p.x,p.y,3*p.life,0,Math.PI*2);ctx.fillStyle=p.color;ctx.globalAlpha=p.life;ctx.fill()}});
    ctx.globalAlpha=1;frame++;
    if(frame<120)requestAnimationFrame(animate);
    else{canvas.style.display='none'}
  }
  animate();
}

// ========== COUNTER ANIMATION ==========
function animateCounter(el, target){
  const start=parseInt(el.textContent.replace(/,/g,''))||0;
  const diff=target-start;if(diff===0)return;
  const duration=600;const startTime=performance.now();
  function step(now){
    const elapsed=now-startTime;const progress=Math.min(elapsed/duration,1);
    const eased=1-Math.pow(1-progress,3);
    el.textContent=Math.round(start+diff*eased).toLocaleString();
    if(progress<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// ========== LEVELS ==========
const LEVELS=[
  {name:'RECRUIT',min:0},{name:'INITIATE',min:100},{name:'OPERATIVE',min:300},
  {name:'AGENT',min:600},{name:'SR. AGENT',min:1000},{name:'COMMANDER',min:1500},
  {name:'ELITE',min:2500},{name:'SHADOW',min:3500},{name:'PHANTOM',min:4500},{name:'SOVEREIGN',min:5500}
];
function getLevel(pts){
  let lvl=LEVELS[0];
  for(const l of LEVELS){if(pts>=l.min)lvl=l;else break}
  return lvl;
}
function getNextLevel(pts){
  for(const l of LEVELS){if(pts<l.min)return l}
  return null;
}

// ========== ACHIEVEMENTS ==========
const ACHIEVEMENTS=[
  {id:'GENESIS',icon:'&#127775;',name:'GENESIS',desc:'First 100 users'},
  {id:'SOCIAL_BUTTERFLY',icon:'&#129419;',name:'SOCIAL',desc:'All social quests'},
  {id:'CODE_WARRIOR',icon:'&#9876;',name:'CODER',desc:'SDK + Dashboard'},
  {id:'STREAK_MASTER',icon:'&#128293;',name:'STREAK',desc:'7-day streak'},
  {id:'QUIZ_ACE',icon:'&#129504;',name:'ACE',desc:'5/5 quiz score'},
  {id:'SPEED_DEMON',icon:'&#9889;',name:'SPEED',desc:'Typing <30s'},
  {id:'WHALE',icon:'&#128051;',name:'WHALE',desc:'Diamond tier'},
  {id:'RECRUITER',icon:'&#129309;',name:'RECRUIT',desc:'5+ referrals'},
  {id:'EARLY_BIRD',icon:'&#127749;',name:'EARLY',desc:'First 24h quest'},
  {id:'COMPLETIONIST',icon:'&#127942;',name:'COMPLETE',desc:'All quests done'}
];

function renderAchievements(){
  const grid=document.getElementById('achievements-grid');
  const unlocked=userProfile?.achievements||[];
  const unlockedIds=unlocked.map(a=>a.achievement_id);
  grid.innerHTML=ACHIEVEMENTS.map(a=>`<div class="achievement-badge ${unlockedIds.includes(a.id)?'unlocked':''}" title="${a.desc}"><div class="badge-icon">${a.icon}</div><div class="badge-name">${a.name}</div></div>`).join('');
}

// ========== AUTH ==========
window.sendMagicLink=async function(){
  const email=document.getElementById('auth-email').value.trim();
  const msg=document.getElementById('auth-msg');
  if(!email){msg.className='auth-msg error';msg.textContent='Enter your email';return}
  const btn=document.getElementById('auth-send-btn');
  btn.disabled=true;btn.textContent='SENDING...';
  try{
    const{error}=await sb.auth.signInWithOtp({email,options:{shouldCreateUser:true}});
    if(error)throw error;
    msg.className='auth-msg success';msg.textContent='Check your email for the OTP code!';
    document.getElementById('auth-email-section').style.display='none';
    document.getElementById('auth-otp-section').classList.add('active');
  }catch(e){msg.className='auth-msg error';msg.textContent=e.message||'Failed to send'}
  finally{btn.disabled=false;btn.textContent='SEND MAGIC LINK'}
};

window.verifyOtp=async function(){
  const email=document.getElementById('auth-email').value.trim();
  const otp=document.getElementById('auth-otp').value.trim();
  const msg=document.getElementById('auth-msg');
  if(!otp||otp.length<6){msg.className='auth-msg error';msg.textContent='Enter 6-digit OTP';return}
  const btn=document.getElementById('auth-verify-btn');
  btn.disabled=true;btn.textContent='VERIFYING...';
  try{
    const{data,error}=await sb.auth.verifyOtp({email,token:otp,type:'email'});
    if(error)throw error;
    currentUser=data.user;
    await initUserProfile();
    document.getElementById('auth-overlay').classList.add('hidden');
    document.getElementById('main-content').classList.remove('blurred');
    document.getElementById('logout-link').style.display='';
    document.getElementById('nav-user').textContent=email;
    await loadAllData();
  }catch(e){msg.className='auth-msg error';msg.textContent=e.message||'Invalid OTP'}
  finally{btn.disabled=false;btn.textContent='VERIFY & ENTER'}
};

window.doLogout=async function(){
  await sb.auth.signOut();
  currentUser=null;userProfile=null;completedQuests={};
  document.getElementById('auth-overlay').classList.remove('hidden');
  document.getElementById('main-content').classList.add('blurred');
  document.getElementById('logout-link').style.display='none';
  document.getElementById('nav-user').textContent='';
  // Reset OTP form
  document.getElementById('auth-email-section').style.display='';
  document.getElementById('auth-otp-section').classList.remove('active');
  document.getElementById('auth-msg').textContent='';
};

// ========== FINGERPRINT ==========
function getFingerprint(){
  const parts=[navigator.userAgent,screen.width+'x'+screen.height,Intl.DateTimeFormat().resolvedOptions().timeZone,navigator.language,navigator.hardwareConcurrency];
  // Simple canvas hash
  try{
    const c=document.createElement('canvas');const ctx=c.getContext('2d');
    ctx.textBaseline='top';ctx.font='14px Arial';ctx.fillText('AW',2,2);
    parts.push(c.toDataURL().slice(-50));
  }catch(e){}
  let hash=0;const str=parts.join('|');
  for(let i=0;i<str.length;i++){hash=((hash<<5)-hash)+str.charCodeAt(i);hash|=0}
  return 'fp_'+Math.abs(hash).toString(36);
}

// ========== INIT USER PROFILE ==========
async function initUserProfile(){
  if(!currentUser)return;
  const refParam=new URLSearchParams(location.search).get('ref');
  try{
    const{data}=await sb.rpc('initialize_quest_user',{p_referral_code:refParam||null});
    // Store fingerprint
    await sb.from('quest_users').update({device_fingerprint:getFingerprint()}).eq('id',currentUser.id);
  }catch(e){console.warn('init user:',e)}
}

// ========== LOAD ALL DATA ==========
async function loadAllData(){
  await Promise.all([loadProfile(),loadQuestDefs(),loadLeaderboard(),loadCommunityStats(),loadActivityFeed(),loadQuizQuestions(),checkCrossPageVerifications()]);
  renderAll();
  subscribeRealtime();
}

async function loadProfile(){
  try{
    const{data}=await sb.rpc('get_user_profile');
    if(data){
      userProfile=data;
      completedQuests={};
      (data.completions||[]).forEach(c=>{completedQuests[c.quest_id]=c.status});
    }
  }catch(e){console.warn('profile:',e)}
}

async function loadQuestDefs(){
  try{
    const{data}=await sb.from('quest_definitions').select('*').eq('enabled',true);
    if(data)data.forEach(q=>{questDefs[q.id]=q});
  }catch(e){console.warn('quest defs:',e)}
}

async function loadQuizQuestions(){
  try{
    const{data}=await sb.from('quiz_questions').select('id,question,options').eq('enabled',true);
    if(data)quizQuestions=data;
  }catch(e){console.warn('quiz:',e)}
}

async function checkCrossPageVerifications(){
  if(!currentUser)return;
  try{
    const{data}=await sb.from('quest_verifications').select('quest_id').eq('user_id',currentUser.id);
    if(data){
      for(const v of data){
        if(!completedQuests[v.quest_id]){
          await sb.rpc('complete_quest',{p_quest_id:v.quest_id});
        }
      }
      if(data.length>0)await loadProfile();
    }
  }catch(e){}
}

// ========== RENDER ==========
function renderAll(){
  if(!userProfile)return;
  const pts=userProfile.total_points||0;

  // Points counter
  animateCounter(document.getElementById('user-pts'),pts);

  // Level
  const lvl=getLevel(pts);
  const next=getNextLevel(pts);
  document.getElementById('level-name').textContent='LVL: '+lvl.name;
  if(next){
    const pct=Math.min((pts-lvl.min)/(next.min-lvl.min)*100,100);
    document.getElementById('xp-fill').style.width=pct+'%';
    document.getElementById('level-sub').textContent=pts+' / '+next.min+' to '+next.name;
  }else{
    document.getElementById('xp-fill').style.width='100%';
    document.getElementById('level-sub').textContent='MAX LEVEL REACHED';
  }

  // Streak
  const streak=userProfile.current_streak||0;
  document.getElementById('streak-num').textContent=streak;
  document.getElementById('streak-detail').textContent=streak>0?streak+' day streak! Next bonus at '+(streak<3?3:streak<7?7:streak<14?14:30)+' days':'Check in daily to start a streak';

  // Streak calendar (last 30 days placeholder)
  const cal=document.getElementById('streak-cal');
  cal.innerHTML='';
  for(let i=29;i>=0;i--){
    const d=document.createElement('div');d.className='streak-day';
    if(i===0)d.classList.add('today');
    if(i<streak)d.classList.add('active');
    cal.appendChild(d);
  }

  // Streak fire scaling
  const fire=document.getElementById('streak-fire');
  const scale=Math.min(1+streak*0.05,2.5);
  fire.style.transform='scale('+scale+')';

  // Referral
  document.getElementById('ref-link').value='https://agentwallet.fun/quest.html?ref='+(userProfile.referral_code||'');
  const refCount=userProfile.referral_count||0;
  document.getElementById('ref-count').textContent=refCount;
  document.getElementById('ref-pts').textContent=(refCount*200).toLocaleString();

  // Nav user
  document.getElementById('nav-user').textContent=(userProfile.email||'').split('@')[0];

  // Quest cards
  document.querySelectorAll('.quest-card[data-quest]').forEach(card=>{
    const qid=card.dataset.quest;
    const btn=card.querySelector('.quest-btn button');
    const def=questDefs[qid];

    // Check completion
    if(completedQuests[qid]==='completed'||completedQuests[qid]==='approved'){
      card.classList.add('completed');
      card.classList.remove('locked','pending');
      if(btn){btn.textContent='DONE';btn.classList.add('done');btn.disabled=true}
    }else if(completedQuests[qid]==='pending_review'){
      card.classList.add('pending');
      card.classList.remove('locked','completed');
      if(btn){btn.textContent='PENDING';btn.disabled=true}
    }else{
      card.classList.remove('completed','pending');
    }

    // Check prerequisites
    if(def&&def.prerequisites&&def.prerequisites.length>0&&!completedQuests[qid]){
      const missing=def.prerequisites.filter(p=>!completedQuests[p]||!['completed','approved'].includes(completedQuests[p]));
      const prereqEl=card.querySelector('.quest-prereq');
      if(missing.length>0){
        card.classList.add('locked');
        if(prereqEl)prereqEl.textContent='REQUIRES: '+missing.join(', ');
        if(btn)btn.disabled=true;
      }else{
        card.classList.remove('locked');
        if(prereqEl)prereqEl.textContent='';
        if(btn&&!btn.classList.contains('done'))btn.disabled=false;
      }
    }

    // Daily checkin special handling
    if(qid==='daily-checkin'){
      card.classList.remove('completed');
      const today=new Date().toISOString().split('T')[0];
      if(userProfile.last_checkin_date===today){
        if(btn){btn.textContent='DONE TODAY';btn.classList.add('done');btn.disabled=true}
      }else{
        if(btn){btn.textContent='CHECK IN';btn.classList.remove('done');btn.disabled=false}
      }
    }
  });

  // Achievements
  renderAchievements();

  // Participants count
  animateCounter(document.getElementById('total-participants'),communityStats.total_users||0);
}

// ========== COMMUNITY STATS ==========
let communityStats={total_users:0,total_points:0,total_completions:0};

async function loadCommunityStats(){
  try{
    const{data}=await sb.rpc('get_community_stats');
    if(data)communityStats=data;
    // Community goal bar
    const totalPts=communityStats.total_points||0;
    const pct=Math.min(totalPts/100000*100,100);
    document.getElementById('cg-fill').style.width=pct+'%';
    if(totalPts>=10000)document.getElementById('cg-10k').classList.add('reached');
    if(totalPts>=50000)document.getElementById('cg-50k').classList.add('reached');
    if(totalPts>=100000)document.getElementById('cg-100k').classList.add('reached');
  }catch(e){}
}

// ========== LEADERBOARD ==========
async function loadLeaderboard(){
  try{
    const{data}=await sb.rpc('get_leaderboard',{p_limit:10});
    const tbody=document.getElementById('lb-body');
    if(!data||data.length===0){
      tbody.innerHTML='<tr><td colspan="4" style="color:var(--dim);text-align:center;padding:20px">No agents yet. Be the first!</td></tr>';
      return;
    }
    const tierColors={DIAMOND:'var(--c)',GOLD:'var(--y)',SILVER:'#c0c0c0',BRONZE:'#cd7f32',RECRUIT:'var(--dim)'};
    let rows=data.map(r=>{
      const isYou=currentUser&&userProfile&&r.display_name===userProfile.display_name;
      return `<tr class="${isYou?'lb-you':''}"><td class="lb-rank">${r.rank}</td><td style="color:var(--c)">${r.display_name}</td><td style="color:var(--y)">${(r.total_points||0).toLocaleString()}</td><td><span style="color:${tierColors[r.tier]||'var(--dim)'}">${r.tier}</span></td></tr>`;
    }).join('');

    // Add current user if not in top 10
    if(userProfile){
      const inTop=data.some(r=>r.display_name===userProfile.display_name);
      if(!inTop){
        const pts=userProfile.total_points||0;
        let tier='RECRUIT';if(pts>=5000)tier='DIAMOND';else if(pts>=3000)tier='GOLD';else if(pts>=1500)tier='SILVER';else if(pts>=500)tier='BRONZE';
        rows+=`<tr class="lb-you"><td class="lb-rank">${userProfile.rank||'--'}</td><td>YOU</td><td>${pts.toLocaleString()}</td><td><span style="color:${tierColors[tier]}">${tier}</span></td></tr>`;
      }
    }
    tbody.innerHTML=rows;
  }catch(e){console.warn('leaderboard:',e)}
}

// ========== ACTIVITY FEED ==========
async function loadActivityFeed(){
  try{
    const{data}=await sb.rpc('get_activity_feed',{p_limit:20});
    renderFeed(data||[]);
  }catch(e){}
}

function renderFeed(items){
  const list=document.getElementById('feed-list');
  if(!items||items.length===0){list.innerHTML='<div class="feed-item">No activity yet</div>';return}
  list.innerHTML=items.map(i=>{
    const ago=timeAgo(new Date(i.created_at));
    return `<div class="feed-item"><span>${i.user_display} ${i.action_text} <span class="feed-pts">+${i.points}</span></span><span class="feed-time">${ago}</span></div>`;
  }).join('');
}

function timeAgo(date){
  const s=Math.floor((Date.now()-date.getTime())/1000);
  if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';
}

// ========== REALTIME SUBSCRIPTION ==========
function subscribeRealtime(){
  sb.channel('activity_feed_changes')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'activity_feed'},payload=>{
      const item=payload.new;
      const list=document.getElementById('feed-list');
      const div=document.createElement('div');
      div.className='feed-item';
      div.innerHTML=`<span>${item.user_display} ${item.action_text} <span class="feed-pts">+${item.points}</span></span><span class="feed-time">now</span>`;
      div.style.animation='slideIn .3s';
      list.insertBefore(div,list.firstChild);
      // Keep max 20
      while(list.children.length>20)list.removeChild(list.lastChild);
    })
    .subscribe();
}

// ========== QUEST ACTIONS ==========
const cooldownTimers={};

window.startQuest=async function(questId, url){
  if(!currentUser){showAuthRequired();return}
  if(completedQuests[questId])return;

  const def=questDefs[questId];
  if(!def)return;
  const card=document.getElementById('card-'+questId);
  const btn=card?.querySelector('.quest-btn button');

  if(def.cooldown_seconds>0){
    // Start attempt
    try{
      const{data}=await sb.rpc('start_quest_attempt',{p_quest_id:questId});
      if(data.status==='already_completed'){await loadProfile();renderAll();return}
      if(data.status==='cooldown'){
        showCooldown(btn,data.remaining);return;
      }

      // Open URL
      if(url){window.open(url.startsWith('http')?url:url,'_blank')}

      // Start cooldown timer
      showCooldown(btn,def.cooldown_seconds,async()=>{
        // Auto-complete after cooldown
        const{data:result}=await sb.rpc('complete_quest',{p_quest_id:questId});
        if(result.status==='completed'||result.status==='pending_review'){
          soundQuestComplete();showConfetti();
          await loadProfile();renderAll();
          card.classList.add('glow-pulse');
          setTimeout(()=>card.classList.remove('glow-pulse'),1000);
          checkLevelUp(userProfile.total_points-def.points,userProfile.total_points);
        }
      });
    }catch(e){console.warn(e)}
  }else{
    // No cooldown - open URL and complete
    if(url){window.open(url.startsWith('http')?url:url,'_blank')}
    try{
      const{data}=await sb.rpc('complete_quest',{p_quest_id:questId});
      if(data.status==='completed'){
        soundQuestComplete();showConfetti();
        await loadProfile();renderAll();
        card?.classList.add('glow-pulse');
        setTimeout(()=>card?.classList.remove('glow-pulse'),1000);
        checkLevelUp((userProfile.total_points||0)-def.points,userProfile.total_points||0);
      }
    }catch(e){console.warn(e)}
  }
};

function showCooldown(btn, seconds, onComplete){
  if(!btn)return;
  btn.disabled=true;btn.classList.add('counting');
  let remaining=Math.ceil(seconds);
  btn.textContent=remaining+'s';
  const interval=setInterval(()=>{
    remaining--;
    if(remaining<=0){
      clearInterval(interval);
      btn.classList.remove('counting');
      btn.textContent='CONFIRMING...';
      if(onComplete)onComplete().then(()=>{}).catch(()=>{btn.textContent='EXECUTE';btn.disabled=false});
    }else{
      btn.textContent=remaining+'s';
    }
  },1000);
}

function showAuthRequired(){
  document.getElementById('auth-overlay').classList.remove('hidden');
}

// ========== PROOF-BASED QUESTS ==========
window.toggleExpand=function(questId){
  const el=document.getElementById('expand-'+questId);
  if(el)el.classList.toggle('open');
};

window.openTweetComposer=function(){
  const tweetText="Just discovered @agentwallet_pro \u2014 the financial infrastructure for autonomous AI agents on @solana \ud83e\udd16\n\nTrustless escrow, spending limits, 27 MCP tools, x402 payments. This is how agents become economic actors.\n\nJoining the beta quest \u2192 agentwallet.fun/quest.html\n\n#AgentWallet #Solana #AI #MCP #web3";
  window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(tweetText),'_blank');
};

window.submitProofQuest=async function(questId){
  if(!currentUser){showAuthRequired();return}
  const input=document.getElementById('proof-'+questId);
  const proofUrl=input?.value?.trim()||'';
  const proofData=null;

  const def=questDefs[questId];
  if(!def)return;

  // For install-sdk, proof is in textarea
  let proofContent=proofUrl;
  if(questId==='install-sdk'){
    const ta=document.getElementById('proof-install-sdk');
    proofContent=ta?.value?.trim()||'';
    if(!proofContent||!proofContent.toLowerCase().includes('aw-protocol-sdk')){
      alert('Paste valid pip show output containing aw-protocol-sdk');return;
    }
  }

  if(def.requires_proof&&!proofContent){
    alert('Proof URL is required for this quest');return;
  }

  try{
    // Start attempt if cooldown
    if(def.cooldown_seconds>0){
      await sb.rpc('start_quest_attempt',{p_quest_id:questId});
    }
    const{data}=await sb.rpc('complete_quest',{
      p_quest_id:questId,
      p_proof_url:proofContent||null,
      p_proof_data:proofData
    });
    if(data.status==='completed'||data.status==='pending_review'){
      soundQuestComplete();showConfetti();
      await loadProfile();renderAll();
      if(data.status==='pending_review'){
        alert('Submitted for review! Points will be awarded after approval.');
      }
    }else if(data.status==='proof_required'){
      alert('Please provide proof URL');
    }else if(data.status==='prerequisite_missing'){
      alert('Complete prerequisite quest first: '+data.missing);
    }else if(data.status==='rate_limited'){
      alert('Rate limit: Max 15 quest completions per day');
    }
  }catch(e){alert(e.message||'Error submitting quest')}
};

// ========== DAILY CHECK-IN ==========
window.doDailyCheckin=async function(){
  if(!currentUser){showAuthRequired();return}
  try{
    const{data}=await sb.rpc('daily_checkin');
    if(data.status==='checked_in'){
      soundCheckin();showConfetti();
      if(data.bonus>0){
        setTimeout(()=>alert('Streak bonus! +'+data.bonus+' points ('+data.bonus_reason+')'),500);
      }
      await loadProfile();renderAll();
    }else if(data.status==='already_checked_in'){
      alert('Already checked in today! Come back tomorrow.');
    }
  }catch(e){alert(e.message||'Check-in failed')}
};

// ========== KNOWLEDGE QUIZ ==========
window.openQuiz=async function(){
  if(!currentUser){showAuthRequired();return}
  if(completedQuests['knowledge-quiz']){alert('Already completed!');return}

  // Select 5 random questions
  const shuffled=[...quizQuestions].sort(()=>Math.random()-0.5);
  selectedQuizQuestions=shuffled.slice(0,5);
  quizAnswers={};

  const container=document.getElementById('quiz-questions');
  container.innerHTML=selectedQuizQuestions.map((q,i)=>{
    const opts=typeof q.options==='string'?JSON.parse(q.options):q.options;
    return `<div class="quiz-q"><div class="q-text">${i+1}. ${q.question}</div>${opts.map((o,j)=>`<button class="q-opt" onclick="selectQuizAnswer(${q.id},${j},this)">${o}</button>`).join('')}</div>`;
  }).join('');

  document.getElementById('quiz-result').textContent='';
  document.getElementById('quiz-modal').classList.add('open');
};

window.selectQuizAnswer=function(qid,idx,btn){
  quizAnswers[qid]=idx;
  // Highlight selected
  btn.parentElement.querySelectorAll('.q-opt').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
};

window.submitQuiz=async function(){
  if(Object.keys(quizAnswers).length<selectedQuizQuestions.length){
    alert('Answer all questions first');return;
  }
  const answers=selectedQuizQuestions.map(q=>({question_id:q.id,answer:quizAnswers[q.id]}));
  try{
    const{data}=await sb.rpc('submit_quiz',{p_answers:answers});
    const resultEl=document.getElementById('quiz-result');
    if(data.status==='passed'){
      resultEl.innerHTML=`<span style="color:var(--g)">PASSED! ${data.score}/${data.total} correct. +${data.points} points!</span>`;
      soundQuestComplete();showConfetti();
      await loadProfile();renderAll();
    }else{
      resultEl.innerHTML=`<span style="color:var(--r)">FAILED. ${data.score}/${data.total} correct. Need 4/5 to pass. Try again!</span>`;
    }
  }catch(e){alert(e.message||'Quiz error')}
};

window.closeQuiz=function(){
  document.getElementById('quiz-modal').classList.remove('open');
};

// ========== TYPING CHALLENGE ==========
window.checkTyping=function(){
  const target=document.getElementById('typing-target').textContent;
  const input=document.getElementById('typing-input').value;
  if(!typingStartTime&&input.length>0)typingStartTime=Date.now();

  // Accuracy
  let correct=0;
  for(let i=0;i<input.length;i++){if(i<target.length&&input[i]===target[i])correct++}
  const accuracy=input.length>0?Math.round(correct/input.length*100):0;
  document.getElementById('typing-accuracy').textContent=accuracy+'%';

  // WPM
  if(typingStartTime){
    const elapsed=(Date.now()-typingStartTime)/1000;
    document.getElementById('typing-time').textContent=Math.round(elapsed)+'s';
    const words=input.trim().split(/\s+/).length;
    const wpm=elapsed>0?Math.round(words/(elapsed/60)):0;
    document.getElementById('typing-wpm').textContent=wpm;
  }
};

window.submitTyping=async function(){
  if(!currentUser){showAuthRequired();return}
  const target=document.getElementById('typing-target').textContent;
  const input=document.getElementById('typing-input').value;
  if(!typingStartTime){alert('Start typing first');return}

  const elapsed=(Date.now()-typingStartTime)/1000;
  let correct=0;for(let i=0;i<input.length;i++){if(i<target.length&&input[i]===target[i])correct++}
  const accuracy=input.length>0?Math.round(correct/Math.max(input.length,target.length)*100):0;
  const words=input.trim().split(/\s+/).length;
  const wpm=elapsed>0?Math.round(words/(elapsed/60)):0;

  if(accuracy<90){alert('Accuracy too low ('+accuracy+'%). Need 90%+.');return}
  if(wpm<20||wpm>200){alert('WPM out of range ('+wpm+'). Must be 20-200.');return}

  try{
    const{data}=await sb.rpc('complete_quest',{
      p_quest_id:'typing-challenge',
      p_proof_data:{accuracy,wpm,elapsed:Math.round(elapsed)}
    });
    if(data.status==='completed'){
      soundQuestComplete();showConfetti();
      await loadProfile();renderAll();
    }else if(data.status==='already_completed'){
      alert('Already completed!');
    }
  }catch(e){alert(e.message||'Error')}
};

window.resetTyping=function(){
  document.getElementById('typing-input').value='';
  typingStartTime=null;
  document.getElementById('typing-accuracy').textContent='0%';
  document.getElementById('typing-wpm').textContent='0';
  document.getElementById('typing-time').textContent='0s';
};

// ========== LEVEL UP CHECK ==========
function checkLevelUp(oldPts, newPts){
  const oldLevel=getLevel(oldPts);
  const newLevel=getLevel(newPts);
  if(newLevel.name!==oldLevel.name){
    soundLevelUp();
    particleBurst();
  }
}

// ========== REFERRAL COPY ==========
window.copyRef=function(){
  const input=document.getElementById('ref-link');
  navigator.clipboard.writeText(input.value).then(()=>{
    const btn=input.nextElementSibling;btn.textContent='COPIED!';
    setTimeout(()=>btn.textContent='COPY',1500);
  });
};

// ========== COUNTDOWN ==========
const endDate=new Date();endDate.setDate(endDate.getDate()+7);endDate.setHours(23,59,59,0);
function updateCountdown(){
  const now=new Date(),diff=endDate-now;
  if(diff<=0){document.getElementById('cd-days').textContent='00';document.getElementById('cd-hours').textContent='00';document.getElementById('cd-mins').textContent='00';document.getElementById('cd-secs').textContent='00';return}
  const d=Math.floor(diff/86400000),h=Math.floor(diff%86400000/3600000),m=Math.floor(diff%3600000/60000),s=Math.floor(diff%60000/1000);
  document.getElementById('cd-days').textContent=String(d).padStart(2,'0');
  document.getElementById('cd-hours').textContent=String(h).padStart(2,'0');
  document.getElementById('cd-mins').textContent=String(m).padStart(2,'0');
  document.getElementById('cd-secs').textContent=String(s).padStart(2,'0');
}
updateCountdown();setInterval(updateCountdown,1000);

// ========== INIT ==========
(async()=>{
  // Check existing session
  const{data:{session}}=await sb.auth.getSession();
  if(session&&session.user){
    currentUser=session.user;
    document.getElementById('auth-overlay').classList.add('hidden');
    document.getElementById('main-content').classList.remove('blurred');
    document.getElementById('logout-link').style.display='';
    await initUserProfile();
    await loadAllData();
  }else{
    document.getElementById('main-content').classList.add('blurred');
    // Still load public stats
    try{
      const{data}=await sb.rpc('get_community_stats');
      if(data){
        communityStats=data;
        animateCounter(document.getElementById('total-participants'),data.total_users||0);
      }
    }catch(e){}
  }
})();

// ── PARTICLES ──
const pc=document.getElementById('particles'),px=pc.getContext('2d');
function resP(){pc.width=innerWidth;pc.height=innerHeight}resP();addEventListener('resize',resP);
const ptsList=[];for(let i=0;i<60;i++)ptsList.push({x:Math.random()*pc.width,y:Math.random()*pc.height,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,r:Math.random()*1.5+.5});
function drawP(){px.clearRect(0,0,pc.width,pc.height);for(let i=0;i<ptsList.length;i++){const p=ptsList[i];p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=pc.width;if(p.x>pc.width)p.x=0;if(p.y<0)p.y=pc.height;if(p.y>pc.height)p.y=0;px.beginPath();px.arc(p.x,p.y,p.r,0,Math.PI*2);px.fillStyle='rgba(0,255,65,0.5)';px.fill();for(let j=i+1;j<ptsList.length;j++){const q=ptsList[j],dx=p.x-q.x,dy=p.y-q.y,d=Math.sqrt(dx*dx+dy*dy);if(d<120){px.beginPath();px.moveTo(p.x,p.y);px.lineTo(q.x,q.y);px.strokeStyle='rgba(0,255,65,'+(1-d/120)*.1+')';px.lineWidth=.5;px.stroke()}}}requestAnimationFrame(drawP)}drawP();

// ── SCROLL PROGRESS ──
addEventListener('scroll',()=>{const h=document.documentElement.scrollHeight-innerHeight;if(h>0)document.getElementById('scroll-prog').style.width=(scrollY/h*100)+'%'});

// ── RANDOM GLITCH ──
setInterval(()=>{
  const els=document.querySelectorAll('.quest-name,.quest-section-title,.tier-name,.lb-title,.referral-title,.level-name');
  if(!els.length)return;
  const el=els[Math.floor(Math.random()*els.length)];
  el.style.animation='none';el.offsetHeight;
  el.style.animation='tGlitch .15s linear';
  setTimeout(()=>{el.style.animation=''},150);
},3000+Math.random()*4000);

// ── HOVER GLOW ──
document.querySelectorAll('.quest-card,.tier,.footer-link,.nav-link').forEach(el=>{
  el.addEventListener('mouseenter',()=>{el.style.textShadow='0 0 12px rgba(0,255,65,.3)'});
  el.addEventListener('mouseleave',()=>{el.style.textShadow=''});
});

})();
</script>
</body>
</html>
