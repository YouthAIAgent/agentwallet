#!/usr/bin/env bash
# AgentWallet CLI helper — ./aw <command>
# Type: ./aw help  to see all commands

BGREEN='\033[1;32m'
GREEN='\033[0;32m'
BCYAN='\033[1;36m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
WHITE='\033[1;37m'
DIM='\033[2m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

CMD="${1:-help}"

# ── Help ──────────────────────────────────────────────────────────────────────
cmd_help() {
  printf "\n"
  printf "  ${BGREEN}AgentWallet Protocol${NC}  ${DIM}v0.4.0${NC}\n"
  printf "  ${DIM}Give your AI agent a wallet.${NC}\n\n"

  printf "  ${BOLD}GETTING STARTED${NC}\n"
  printf "  ${YELLOW}./aw setup${NC}      ${DIM}·${NC}  First-time setup after git clone\n"
  printf "  ${YELLOW}./aw start${NC}      ${DIM}·${NC}  Start API + PostgreSQL + Redis\n"
  printf "  ${YELLOW}./aw status${NC}     ${DIM}·${NC}  Check if everything is running\n"
  printf "  ${YELLOW}./aw stop${NC}       ${DIM}·${NC}  Stop all services\n"
  printf "\n"

  printf "  ${BOLD}DEVELOPMENT${NC}\n"
  printf "  ${YELLOW}./aw logs${NC}       ${DIM}·${NC}  Tail API logs (Ctrl+C to exit)\n"
  printf "  ${YELLOW}./aw test${NC}       ${DIM}·${NC}  Run all 110 tests\n"
  printf "  ${YELLOW}./aw lint${NC}       ${DIM}·${NC}  Check code style (ruff)\n"
  printf "  ${YELLOW}./aw shell${NC}      ${DIM}·${NC}  Open bash inside API container\n"
  printf "  ${YELLOW}./aw restart${NC}    ${DIM}·${NC}  Restart API after code changes\n"
  printf "\n"

  printf "  ${BOLD}DATABASE${NC}\n"
  printf "  ${YELLOW}./aw db${NC}         ${DIM}·${NC}  Open PostgreSQL shell\n"
  printf "  ${YELLOW}./aw migrate${NC}    ${DIM}·${NC}  Run Alembic database migrations\n"
  printf "  ${YELLOW}./aw clean${NC}      ${DIM}·${NC}  Full reset — stop + delete all data\n"
  printf "\n"

  printf "  ${BOLD}API & DOCS${NC}\n"
  printf "  ${YELLOW}./aw health${NC}     ${DIM}·${NC}  Check API health endpoint\n"
  printf "  ${YELLOW}./aw open${NC}       ${DIM}·${NC}  Open Swagger docs in browser\n"
  printf "\n"

  printf "  ${DIM}Tip: Most commands also work with 'make <command>'${NC}\n"
  printf "  ${DIM}Docs: README.md  |  Live API: https://api.agentwallet.fun/docs${NC}\n\n"
}

# ── Setup ─────────────────────────────────────────────────────────────────────
cmd_setup() {
  bash setup.sh
}

# ── Start ─────────────────────────────────────────────────────────────────────
cmd_start() {
  printf "${BGREEN}Starting services...${NC}\n"
  docker compose up -d postgres redis api
  printf "${BGREEN}[OK]${NC} API running at ${CYAN}http://localhost:8000${NC}\n"
  printf "${DIM}     Docs: http://localhost:8000/docs${NC}\n"
}

# ── Stop ──────────────────────────────────────────────────────────────────────
cmd_stop() {
  printf "${YELLOW}Stopping services...${NC}\n"
  docker compose down
  printf "${BGREEN}[OK]${NC} All services stopped.\n"
}

# ── Restart ───────────────────────────────────────────────────────────────────
cmd_restart() {
  printf "${YELLOW}Restarting API...${NC}\n"
  docker compose restart api
  printf "${BGREEN}[OK]${NC} API restarted.\n"
}

# ── Status ────────────────────────────────────────────────────────────────────
cmd_status() {
  printf "\n  ${BOLD}Service Status${NC}\n\n"

  # API health
  if command -v curl >/dev/null 2>&1; then
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health 2>/dev/null || echo "000")
    if [ "$STATUS" = "200" ]; then
      printf "  ${BGREEN}[UP]${NC}   API        http://localhost:8000\n"
    else
      printf "  ${RED}[DOWN]${NC} API        http://localhost:8000  (HTTP $STATUS)\n"
    fi
  fi

  # Docker containers
  if docker ps --format "{{.Names}}\t{{.Status}}" 2>/dev/null | grep -q agentwallet; then
    docker ps --format "{{.Names}}\t{{.Status}}" 2>/dev/null | grep agentwallet | while read name status; do
      short=$(echo "$name" | sed 's/agentwallet-//;s/-1//')
      printf "  ${BGREEN}[UP]${NC}   %-10s %s\n" "$short" "$status"
    done
  else
    printf "  ${RED}[DOWN]${NC} No AgentWallet containers running\n"
    printf "         Run: ${YELLOW}./aw start${NC}\n"
  fi
  printf "\n"
}

# ── Logs ──────────────────────────────────────────────────────────────────────
cmd_logs() {
  printf "${DIM}Tailing API logs (Ctrl+C to exit)...${NC}\n"
  docker compose logs -f api
}

# ── Test ──────────────────────────────────────────────────────────────────────
cmd_test() {
  printf "${BGREEN}Running tests...${NC}\n"
  pip install -e ".[dev]" -q
  pytest packages/api/tests -v --tb=short
}

# ── Lint ──────────────────────────────────────────────────────────────────────
cmd_lint() {
  command -v ruff >/dev/null 2>&1 || pip install ruff -q
  ruff check packages/api/agentwallet/
}

# ── Shell ─────────────────────────────────────────────────────────────────────
cmd_shell() {
  printf "${DIM}Opening bash inside API container...${NC}\n"
  docker compose exec api bash
}

# ── DB ────────────────────────────────────────────────────────────────────────
cmd_db() {
  printf "${DIM}Opening PostgreSQL shell...${NC}\n"
  docker compose exec postgres psql -U agentwallet
}

# ── Migrate ───────────────────────────────────────────────────────────────────
cmd_migrate() {
  printf "${BGREEN}Running migrations...${NC}\n"
  docker compose exec api alembic upgrade head
}

# ── Health ────────────────────────────────────────────────────────────────────
cmd_health() {
  printf "${DIM}Checking API health...${NC}\n"
  curl -s http://localhost:8000/health | python -m json.tool 2>/dev/null \
    || curl -s http://localhost:8000/health \
    || printf "${RED}API not reachable. Is it running? Try: ./aw start${NC}\n"
}

# ── Open ──────────────────────────────────────────────────────────────────────
cmd_open() {
  URL="http://localhost:8000/docs"
  printf "${DIM}Opening $URL ...${NC}\n"
  # Cross-platform open
  if command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$URL"
  elif command -v open >/dev/null 2>&1; then
    open "$URL"
  elif command -v start >/dev/null 2>&1; then
    start "$URL"
  else
    printf "${YELLOW}Open this URL in your browser: $URL${NC}\n"
  fi
}

# ── Clean ─────────────────────────────────────────────────────────────────────
cmd_clean() {
  printf "${RED}WARNING: This deletes ALL local data (Postgres volumes).${NC}\n"
  printf "Press Enter to continue or Ctrl+C to cancel...\n"
  read -r _
  docker compose down -v
  printf "${BGREEN}[OK]${NC} Clean done. Run ${YELLOW}./aw setup${NC} to start fresh.\n"
}

# ── Unknown ───────────────────────────────────────────────────────────────────
cmd_unknown() {
  printf "${RED}Unknown command: $CMD${NC}\n"
  printf "Run ${YELLOW}./aw help${NC} to see all commands.\n"
  exit 1
}

# ── Dispatch ──────────────────────────────────────────────────────────────────
case "$CMD" in
  help|--help|-h)   cmd_help ;;
  setup)            cmd_setup ;;
  start)            cmd_start ;;
  stop)             cmd_stop ;;
  restart)          cmd_restart ;;
  status)           cmd_status ;;
  logs)             cmd_logs ;;
  test)             cmd_test ;;
  lint)             cmd_lint ;;
  shell)            cmd_shell ;;
  db)               cmd_db ;;
  migrate)          cmd_migrate ;;
  health)           cmd_health ;;
  open)             cmd_open ;;
  clean)            cmd_clean ;;
  *)                cmd_unknown ;;
esac
