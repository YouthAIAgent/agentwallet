<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentWallet Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--surface:#0f0f0f;--border:#1a1a1a;--green:#00ff41;--cyan:#00d4ff;--magenta:#ff2a6d;--purple:#b44aff;--yellow:#ffd700;--orange:#ff6b00;--text:#c0c0c0;--text-dim:#666}
body{font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
canvas#matrix{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;opacity:.06;pointer-events:none}
.crt::after{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.08) 2px,rgba(0,0,0,.08) 4px);pointer-events:none;z-index:9999}

/* Auth Screen */
#auth-screen{position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;background:var(--bg)}
#auth-screen.hidden{display:none}
.auth-box{background:rgba(15,15,15,.85);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:12px;padding:40px;width:420px;max-width:92vw;position:relative;z-index:10}
.auth-box h1{font-size:1.6rem;text-align:center;margin-bottom:6px;background:linear-gradient(90deg,var(--green),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-box .sub{text-align:center;color:var(--text-dim);font-size:.75rem;margin-bottom:28px}
.auth-tabs{display:flex;gap:4px;margin-bottom:24px}
.auth-tabs button{flex:1;padding:10px;background:transparent;border:1px solid var(--border);color:var(--text-dim);font-family:inherit;font-size:.8rem;cursor:pointer;border-radius:6px;transition:.2s}
.auth-tabs button.active{border-color:var(--green);color:var(--green);background:rgba(0,255,65,.05)}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:.7rem;color:var(--text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;font-size:.85rem;outline:none;transition:.2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--cyan);box-shadow:0 0 12px rgba(0,212,255,.15)}
.btn{padding:10px 20px;border:1px solid var(--green);background:rgba(0,255,65,.08);color:var(--green);font-family:inherit;font-size:.85rem;cursor:pointer;border-radius:6px;transition:.2s;width:100%}
.btn:hover{background:rgba(0,255,65,.18);box-shadow:0 0 20px rgba(0,255,65,.2)}
.btn.cyan{border-color:var(--cyan);color:var(--cyan);background:rgba(0,212,255,.08)}
.btn.cyan:hover{background:rgba(0,212,255,.18)}
.btn.magenta{border-color:var(--magenta);color:var(--magenta);background:rgba(255,42,109,.08)}
.btn.magenta:hover{background:rgba(255,42,109,.18)}
.btn.orange{border-color:var(--orange);color:var(--orange);background:rgba(255,107,0,.08)}
.btn.orange:hover{background:rgba(255,107,0,.18)}
.btn.small{padding:6px 12px;font-size:.72rem;width:auto}
.btn.purple{border-color:var(--purple);color:var(--purple);background:rgba(180,74,255,.08)}
.auth-error{color:var(--magenta);font-size:.75rem;margin-top:10px;min-height:18px}

/* Dashboard Layout */
#dashboard{display:none;position:relative;z-index:1;min-height:100vh}
#dashboard.active{display:flex}
.sidebar{width:220px;min-height:100vh;background:rgba(15,15,15,.9);backdrop-filter:blur(12px);border-right:1px solid var(--border);padding:16px 0;position:fixed;left:0;top:0;z-index:50;transition:transform .3s}
.sidebar .logo{padding:16px 20px 24px;font-size:1.1rem;font-weight:700;color:var(--green);letter-spacing:2px;border-bottom:1px solid var(--border)}
.sidebar .logo span{color:var(--cyan)}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 20px;color:var(--text-dim);font-size:.8rem;cursor:pointer;transition:.2s;border-left:3px solid transparent}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,.02)}
.nav-item.active{color:var(--green);border-left-color:var(--green);background:rgba(0,255,65,.04)}
.nav-item .icon{font-size:1rem;width:20px;text-align:center}
.main{flex:1;margin-left:220px;min-height:100vh}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:rgba(15,15,15,.8);backdrop-filter:blur(10px);position:sticky;top:0;z-index:40}
.topbar-left{display:flex;align-items:center;gap:16px}
.hamburger{display:none;background:none;border:none;color:var(--green);font-size:1.4rem;cursor:pointer}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.badge{padding:3px 10px;border:1px solid var(--cyan);color:var(--cyan);font-size:.65rem;border-radius:4px;letter-spacing:1px}
.topbar-right{display:flex;align-items:center;gap:16px}
.user-email{color:var(--text-dim);font-size:.75rem}
#logout-btn{padding:6px 14px;border:1px solid var(--magenta);background:transparent;color:var(--magenta);font-family:inherit;font-size:.72rem;cursor:pointer;border-radius:4px;transition:.2s}
#logout-btn:hover{background:rgba(255,42,109,.12)}
.content{padding:28px}
.page{display:none}
.page.active{display:block}
.page-title{font-size:1.3rem;color:var(--green);margin-bottom:24px;display:flex;align-items:center;gap:10px}
.page-title span{color:var(--cyan);font-size:.8rem;font-weight:400}

/* Cards & Stats */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:28px}
.stat-card{background:rgba(15,15,15,.7);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:10px;padding:20px;transition:.2s}
.stat-card:hover{border-color:var(--cyan);transform:translateY(-2px)}
.stat-card .label{font-size:.7rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.stat-card .value{font-size:1.8rem;font-weight:700;color:var(--green)}
.stat-card .value.cyan{color:var(--cyan)}
.stat-card .value.purple{color:var(--purple)}
.stat-card .value.yellow{color:var(--yellow)}

/* Tables */
.table-wrap{overflow-x:auto;margin-top:16px}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{text-align:left;padding:10px 14px;color:var(--text-dim);border-bottom:1px solid var(--border);font-size:.68rem;text-transform:uppercase;letter-spacing:1px}
td{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.03);color:var(--text);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
tr:hover td{background:rgba(255,255,255,.02)}
.status-badge{padding:3px 8px;border-radius:4px;font-size:.68rem;font-weight:600}
.status-CREATED{color:var(--yellow);border:1px solid var(--yellow)}
.status-FUNDED,.status-funded{color:var(--cyan);border:1px solid var(--cyan)}
.status-RELEASED,.status-completed{color:var(--green);border:1px solid var(--green)}
.status-REFUNDED{color:var(--orange);border:1px solid var(--orange)}
.status-EXPIRED,.status-failed{color:var(--magenta);border:1px solid var(--magenta)}
.status-DISPUTED{color:var(--purple);border:1px solid var(--purple)}
.status-active,.status-pending{color:var(--cyan);border:1px solid var(--cyan)}

/* Forms */
.form-card{background:rgba(15,15,15,.7);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:10px;padding:24px;margin-bottom:24px;max-width:600px}
.form-card h3{color:var(--cyan);font-size:.9rem;margin-bottom:16px}
.form-row{display:flex;gap:12px;flex-wrap:wrap}
.form-row .form-group{flex:1;min-width:180px}
.inline-actions{display:flex;gap:8px;margin-top:8px}

/* Toast */
#toast-container{position:fixed;top:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:.78rem;animation:slideIn .3s;backdrop-filter:blur(12px);max-width:380px}
.toast.success{background:rgba(0,255,65,.1);border:1px solid var(--green);color:var(--green)}
.toast.error{background:rgba(255,42,109,.1);border:1px solid var(--magenta);color:var(--magenta)}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}

.loading{color:var(--green);font-size:.8rem;padding:20px;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* Mobile */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}
  .hamburger{display:block}
  .stat-grid{grid-template-columns:1fr 1fr}
  .content{padding:16px}
  .topbar{padding:12px 16px}
  .auth-box{padding:24px}
}
@media(max-width:480px){
  .stat-grid{grid-template-columns:1fr}
}

/* ── COLORFUL CARD BORDERS ── */
.stat-card:nth-child(1){border-top:2px solid var(--green)}.stat-card:nth-child(2){border-top:2px solid var(--cyan)}.stat-card:nth-child(3){border-top:2px solid var(--purple)}.stat-card:nth-child(4){border-top:2px solid var(--yellow)}
.stat-card:nth-child(1) .value{color:var(--green)}.stat-card:nth-child(2) .value{color:var(--cyan)}.stat-card:nth-child(3) .value{color:var(--purple)}.stat-card:nth-child(4) .value{color:var(--yellow)}
.stat-card:nth-child(1):hover{border-top-color:var(--green);box-shadow:0 0 25px rgba(0,255,65,.15)}.stat-card:nth-child(2):hover{border-top-color:var(--cyan);box-shadow:0 0 25px rgba(0,212,255,.15)}.stat-card:nth-child(3):hover{border-top-color:var(--purple);box-shadow:0 0 25px rgba(180,74,255,.15)}.stat-card:nth-child(4):hover{border-top-color:var(--yellow);box-shadow:0 0 25px rgba(255,215,0,.15)}
.auth-box{position:relative;overflow:visible}.auth-box::before{content:'';position:absolute;inset:-2px;background:linear-gradient(45deg,var(--green),var(--cyan),var(--magenta),var(--purple),var(--green));background-size:400% 400%;z-index:-1;border-radius:14px;animation:gradBorder 6s ease infinite;opacity:.4}
@keyframes gradBorder{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.nav-item:hover{background:rgba(0,255,65,.04);text-shadow:0 0 8px rgba(0,255,65,.2)}
table th{background:rgba(0,255,65,.02)}
.btn.purple{border-color:var(--purple);color:var(--purple);background:rgba(180,74,255,.08)}.btn.purple:hover{background:rgba(180,74,255,.18);box-shadow:0 0 20px rgba(180,74,255,.2)}

/* ENHANCED HACKER EFFECTS */
#particles{position:fixed;inset:0;z-index:-1;opacity:.25;pointer-events:none}
.grid-overlay{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(0,255,65,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,65,.02) 1px,transparent 1px);background-size:60px 60px}
#scroll-prog{position:fixed;top:0;left:0;height:3px;z-index:10001;background:linear-gradient(90deg,#00ff41,#00d4ff,#e040fb,#a855f7,#ffcc00);width:0;transition:width .15s}
body{animation:flk 10s infinite}
@keyframes flk{0%,100%{opacity:1}92%{opacity:1}93%{opacity:.85}94%{opacity:1}96%{opacity:.92}97%{opacity:1}}
#boot-overlay{position:fixed;inset:0;z-index:10000;background:#0a0a0a;display:flex;align-items:center;justify-content:center;transition:opacity .8s,visibility .8s}
#boot-overlay.done{opacity:0;visibility:hidden;pointer-events:none}
#boot-inner{max-width:600px;width:90%;padding:30px;font-family:'JetBrains Mono',monospace;font-size:12px;color:#00ff41}
.boot-line{opacity:0;margin-bottom:3px;white-space:pre;transition:opacity .3s}
.boot-line.visible{opacity:1}
.boot-line .tag-ok{color:#00ff41;font-weight:700}
.boot-line .tag-init{color:#ffcc00}
.boot-line .tag-sys{color:#00d4ff}
.boot-line .tag-warn{color:#ff6b00}
.boot-line .tag-load{color:#e040fb}
.stat-card{position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--green),transparent);animation:scanCard 4s linear infinite}
@keyframes scanCard{0%{left:-100%}100%{left:100%}}
.stat-card:hover{box-shadow:0 0 25px rgba(0,255,65,.12);border-color:var(--green)}
.sidebar .logo{text-shadow:0 0 15px rgba(0,255,65,.5),0 0 40px rgba(0,255,65,.2)}
.nav-item{transition:all .3s}
.nav-item::before{content:'>';position:absolute;left:6px;opacity:0;color:var(--green);transition:all .2s}
.nav-item{position:relative}
.nav-item.active::before,.nav-item:hover::before{opacity:1}
.page-title{text-shadow:0 0 20px rgba(0,255,65,.3),0 0 40px rgba(0,255,65,.1)}
.form-card{position:relative;overflow:hidden;transition:all .3s}
.form-card:hover{border-color:var(--cyan);box-shadow:0 0 20px rgba(0,212,255,.08)}
.form-card::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);animation:scanCard 5s linear infinite}
.auth-box h1{text-shadow:0 0 30px rgba(0,255,65,.4),0 0 60px rgba(0,212,255,.2);animation:gsk 4s infinite linear alternate-reverse}
@keyframes gsk{0%,100%{transform:skew(0)}31%{transform:skew(.3deg)}32%{transform:skew(0)}69%{transform:skew(-.2deg)}70%{transform:skew(0)}}
table tr{transition:all .2s}
table tr:hover td{text-shadow:0 0 8px rgba(0,255,65,.2)}
.btn{position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,255,65,.1),transparent);transition:left .5s}
.btn:hover::before{left:100%}
.topbar{backdrop-filter:blur(20px)}
@keyframes tGlitch{0%,100%{opacity:1;transform:translate(0)}33%{opacity:.8;transform:translate(-2px,1px);filter:hue-rotate(90deg)}66%{opacity:.9;transform:translate(1px,-1px)}}
.toast{backdrop-filter:blur(12px);border-left:3px solid}
.toast.success{border-left-color:var(--green)}
.toast.error{border-left-color:var(--magenta)}
</style>
</head>
<body class="crt">
<canvas id="matrix"></canvas>
<canvas id="particles"></canvas>
<div class="grid-overlay"></div>
<div id="scroll-prog"></div>
<div id="boot-overlay"><div id="boot-inner">
<div class="boot-line"><span class="tag-sys">[SYS]</span> AgentWallet Dashboard v0.3.0</div>
<div class="boot-line"><span class="tag-init">[INIT]</span> Connecting to Solana devnet...</div>
<div class="boot-line"><span class="tag-ok">[OK]</span> RPC endpoint: api.devnet.solana.com</div>
<div class="boot-line"><span class="tag-ok">[OK]</span> Protocol engine online — 60 endpoints active</div>
<div class="boot-line"><span class="tag-load">[LOAD]</span> Loading dashboard modules...</div>
<div class="boot-line"><span class="tag-ok">[OK]</span> 14 router groups armed — 33 MCP tools loaded</div>
<div class="boot-line"><span class="tag-ok">[OK]</span> PDA wallet engine online — on-chain limits enforced</div>
<div class="boot-line"><span class="tag-ok">[OK]</span> 84/84 tests passing — all systems green</div>
<div class="boot-line"><span class="tag-warn">[WARN]</span> Mainnet launch: IMMINENT</div>
</div></div>
<div id="toast-container"></div>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-box">
    <h1>AGENT WALLET</h1>
    <div class="sub">// AUTONOMOUS AGENT CONTROL CENTER v0.3.0</div>
    <div class="auth-tabs">
      <button class="active" onclick="showAuthTab('login')">LOGIN</button>
      <button onclick="showAuthTab('register')">REGISTER</button>
    </div>
    <form id="login-form" onsubmit="handleLogin(event)">
      <div class="form-group"><label>Email</label><input type="email" id="login-email" required placeholder="agent@protocol.io"></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-password" required placeholder="********"></div>
      <button type="submit" class="btn">AUTHENTICATE &gt;&gt;</button>
      <div class="auth-error" id="login-error"></div>
    </form>
    <form id="register-form" style="display:none" onsubmit="handleRegister(event)">
      <div class="form-group"><label>Org Name</label><input type="text" id="reg-org" required placeholder="My Organization"></div>
      <div class="form-group"><label>Email</label><input type="email" id="reg-email" required placeholder="agent@protocol.io"></div>
      <div class="form-group"><label>Password</label><input type="password" id="reg-password" required minlength="8" placeholder="min 8 chars"></div>
      <button type="submit" class="btn cyan">REGISTER &gt;&gt;</button>
      <div class="auth-error" id="reg-error"></div>
    </form>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <aside class="sidebar" id="sidebar">
    <div class="logo"><svg viewBox="0 0 64 64" width="26" height="26" style="vertical-align:middle;margin-right:6px"><defs><linearGradient id="dlg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#00ff41"/><stop offset="100%" stop-color="#00d4ff"/></linearGradient></defs><polygon points="32,4 58,18 58,46 32,60 6,46 6,18" fill="#0a0a0f" stroke="url(#dlg)" stroke-width="2.5"/><text x="32" y="40" text-anchor="middle" font-family="monospace" font-size="22" font-weight="800" fill="url(#dlg)">AW</text></svg><span>PROTOCOL</span></div>
    <div class="nav-item active" data-page="overview"><span class="icon">&#9632;</span> Overview</div>
    <div class="nav-item" data-page="agents"><span class="icon">&#9881;</span> Agents</div>
    <div class="nav-item" data-page="wallets"><span class="icon">&#9733;</span> Wallets</div>
    <div class="nav-item" data-page="transactions"><span class="icon">&#8644;</span> Transactions</div>
    <div class="nav-item" data-page="escrow"><span class="icon">&#128274;</span> Escrow</div>
    <div class="nav-item" data-page="policies"><span class="icon">&#9879;</span> Policies</div>
    <div class="nav-item" data-page="pda"><span class="icon">&#128279;</span> PDA Wallets</div>
    <div class="nav-item" data-page="analytics"><span class="icon">&#9670;</span> Analytics</div>
    <div class="nav-item" data-page="audit"><span class="icon">&#9776;</span> Audit Log</div>
  </aside>
  <div class="main">
    <header class="topbar">
      <div class="topbar-left">
        <button class="hamburger" onclick="document.getElementById('sidebar').classList.toggle('open')">&#9776;</button>
        <div class="status-dot"></div>
        <span class="badge">DEVNET</span>
      </div>
      <div class="topbar-right">
        <span class="user-email" id="user-email"></span>
        <button id="logout-btn" onclick="logout()">LOGOUT</button>
      </div>
    </header>
    <div class="content">

      <!-- OVERVIEW PAGE -->
      <div class="page active" id="page-overview">
        <div class="page-title">OVERVIEW <span>// system status</span></div>
        <div class="stat-grid" id="overview-stats">
          <div class="stat-card"><div class="label">Total Agents</div><div class="value" id="stat-agents">--</div></div>
          <div class="stat-card"><div class="label">Total Wallets</div><div class="value cyan" id="stat-wallets">--</div></div>
          <div class="stat-card"><div class="label">Transactions</div><div class="value purple" id="stat-txs">--</div></div>
          <div class="stat-card"><div class="label">Escrows</div><div class="value yellow" id="stat-escrows">--</div></div>
        </div>
        <h3 style="color:var(--cyan);font-size:.85rem;margin-bottom:12px">RECENT TRANSACTIONS</h3>
        <div class="table-wrap"><table><thead><tr><th>Type</th><th>Amount</th><th>Status</th><th>Signature</th><th>Created</th></tr></thead><tbody id="overview-txs"><tr><td colspan="5" class="loading">[LOADING...]</td></tr></tbody></table></div>
        <div class="inline-actions" style="margin-top:20px">
          <button class="btn small" onclick="navigate('agents')">+ Create Agent</button>
          <button class="btn small cyan" onclick="navigate('transactions')">Send SOL</button>
        </div>
      </div>

      <!-- AGENTS PAGE -->
      <div class="page" id="page-agents">
        <div class="page-title">AGENTS <span>// autonomous actors</span></div>
        <div class="form-card">
          <h3>+ CREATE AGENT</h3>
          <form onsubmit="createAgent(event)">
            <div class="form-row">
              <div class="form-group"><label>Name</label><input id="agent-name" required placeholder="my-agent-01"></div>
              <div class="form-group"><label>Description</label><input id="agent-desc" placeholder="Autonomous trading agent"></div>
            </div>
            <div class="form-group"><label>Capabilities (comma-separated)</label><input id="agent-caps" placeholder="transfer,escrow,trade"></div>
            <button type="submit" class="btn small" style="margin-top:4px">DEPLOY AGENT</button>
          </form>
        </div>
        <div class="table-wrap"><table><thead><tr><th>Name</th><th>ID</th><th>Status</th><th>Capabilities</th><th>Created</th></tr></thead><tbody id="agents-table"><tr><td colspan="5" class="loading">[LOADING...]</td></tr></tbody></table></div>
      </div>

      <!-- WALLETS PAGE -->
      <div class="page" id="page-wallets">
        <div class="page-title">WALLETS <span>// on-chain accounts</span></div>
        <div class="form-card">
          <h3>+ CREATE WALLET</h3>
          <form onsubmit="createWallet(event)">
            <div class="form-row">
              <div class="form-group"><label>Agent</label><select id="wallet-agent"></select></div>
              <div class="form-group"><label>Network</label><select id="wallet-network"><option value="solana-devnet">solana-devnet</option><option value="solana-mainnet">solana-mainnet</option></select></div>
            </div>
            <button type="submit" class="btn small cyan" style="margin-top:4px">CREATE WALLET</button>
          </form>
        </div>
        <div class="table-wrap"><table><thead><tr><th>Address</th><th>Network</th><th>Agent ID</th><th>Balance</th><th>Created</th><th></th></tr></thead><tbody id="wallets-table"><tr><td colspan="6" class="loading">[LOADING...]</td></tr></tbody></table></div>
        <div style="margin-top:16px;padding:14px;border:1px solid var(--border);border-radius:8px;font-size:.73rem;color:var(--text-dim)">
          <strong style="color:var(--yellow)">DEVNET AIRDROP:</strong> Use <code style="color:var(--cyan)">solana airdrop 1 &lt;ADDRESS&gt; --url devnet</code> or visit <a href="https://faucet.solana.com" target="_blank" style="color:var(--cyan)">faucet.solana.com</a>
        </div>
      </div>

      <!-- TRANSACTIONS PAGE -->
      <div class="page" id="page-transactions">
        <div class="page-title">TRANSACTIONS <span>// transfer ledger</span></div>
        <div class="form-card">
          <h3>SEND SOL</h3>
          <form onsubmit="sendSol(event)">
            <div class="form-group"><label>From Wallet</label><select id="tx-from-wallet"></select></div>
            <div class="form-row">
              <div class="form-group"><label>To Address</label><input id="tx-to" required placeholder="Recipient Solana address"></div>
              <div class="form-group" style="max-width:140px"><label>Amount (SOL)</label><input type="number" step="0.0001" id="tx-amount" required placeholder="0.1"></div>
            </div>
            <button type="submit" class="btn small magenta" style="margin-top:4px">SEND SOL &gt;&gt;</button>
          </form>
        </div>
        <div class="table-wrap"><table><thead><tr><th>Type</th><th>Amount</th><th>Status</th><th>Signature</th><th>From</th><th>Created</th></tr></thead><tbody id="txs-table"><tr><td colspan="6" class="loading">[LOADING...]</td></tr></tbody></table></div>
      </div>

      <!-- ESCROW PAGE -->
      <div class="page" id="page-escrow">
        <div class="page-title">ESCROW <span>// trustless exchange</span></div>
        <div class="form-card">
          <h3>+ CREATE ESCROW</h3>
          <form onsubmit="createEscrow(event)">
            <div class="form-group"><label>Funder Wallet</label><select id="escrow-wallet"></select></div>
            <div class="form-row">
              <div class="form-group"><label>Recipient Address</label><input id="escrow-recipient" required placeholder="Recipient address"></div>
              <div class="form-group" style="max-width:120px"><label>Amount (SOL)</label><input type="number" step="0.0001" id="escrow-amount" required placeholder="1.0"></div>
              <div class="form-group" style="max-width:120px"><label>Expires (hrs)</label><input type="number" id="escrow-hours" required placeholder="24" value="24"></div>
            </div>
            <button type="submit" class="btn small purple" style="margin-top:4px">CREATE ESCROW</button>
          </form>
        </div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Amount</th><th>Status</th><th>Recipient</th><th>Expires</th><th>Actions</th></tr></thead><tbody id="escrow-table"><tr><td colspan="6" class="loading">[LOADING...]</td></tr></tbody></table></div>
      </div>

      <!-- POLICIES PAGE -->
      <div class="page" id="page-policies">
        <div class="page-title">POLICIES <span>// access control</span></div>
        <div class="form-card">
          <h3>+ CREATE POLICY</h3>
          <form onsubmit="createPolicy(event)">
            <div class="form-row">
              <div class="form-group"><label>Name</label><input id="policy-name" required placeholder="daily-limit-policy"></div>
              <div class="form-group"><label>Scope Type</label><select id="policy-scope"><option value="agent">agent</option><option value="wallet">wallet</option><option value="org">org</option></select></div>
              <div class="form-group"><label>Scope ID</label><input id="policy-sid" required placeholder="target ID"></div>
            </div>
            <div class="form-group"><label>Rules (JSON)</label><textarea id="policy-rules" rows="3" placeholder='{"max_daily_sol": 10, "allowed_networks": ["solana-devnet"]}'></textarea></div>
            <button type="submit" class="btn small orange" style="margin-top:4px">CREATE POLICY</button>
          </form>
        </div>
        <div class="table-wrap"><table><thead><tr><th>Name</th><th>Scope</th><th>Scope ID</th><th>Enabled</th><th>Rules</th><th>Created</th></tr></thead><tbody id="policies-table"><tr><td colspan="6" class="loading">[LOADING...]</td></tr></tbody></table></div>
      </div>

      <!-- PDA WALLETS PAGE -->
      <div class="page" id="page-pda">
        <div class="page-title">PDA WALLETS <span>// on-chain policy enforcement</span></div>
        <div class="stat-grid">
          <div class="stat-card"><div class="label">Anchor Program</div><div class="value" style="font-size:.65rem;color:var(--cyan);word-break:break-all">CEQLGCWk...pt6r6</div></div>
          <div class="stat-card"><div class="label">Network</div><div class="value cyan">DEVNET</div></div>
          <div class="stat-card"><div class="label">Enforcement</div><div class="value" style="color:var(--green)">ON-CHAIN</div></div>
          <div class="stat-card"><div class="label">Limits</div><div class="value yellow">PER-TX + DAILY</div></div>
        </div>
        <div class="form-card">
          <h3 style="color:var(--purple)">+ CREATE PDA WALLET</h3>
          <form onsubmit="createPDA(event)">
            <div class="form-row">
              <div class="form-group"><label>Agent</label><select id="pda-agent"></select></div>
              <div class="form-group"><label>Daily Limit (SOL)</label><input type="number" step="0.01" id="pda-daily" required placeholder="10.0" value="10"></div>
              <div class="form-group"><label>Per-TX Limit (SOL)</label><input type="number" step="0.01" id="pda-pertx" required placeholder="1.0" value="1"></div>
            </div>
            <button type="submit" class="btn small purple" style="margin-top:4px">DEPLOY PDA WALLET ON-CHAIN &gt;&gt;</button>
          </form>
        </div>
        <div class="table-wrap"><table><thead><tr><th>PDA Address</th><th>Agent</th><th>Daily Limit</th><th>Per-TX</th><th>Active</th><th>Created</th></tr></thead><tbody id="pda-table"><tr><td colspan="6" class="loading">[LOADING...]</td></tr></tbody></table></div>
      </div>

      <!-- ANALYTICS PAGE -->
      <div class="page" id="page-analytics">
        <div class="page-title">ANALYTICS <span>// metrics overview</span></div>
        <div class="stat-grid" id="analytics-grid"><div class="stat-card"><div class="loading">[LOADING...]</div></div></div>
      </div>

      <!-- AUDIT LOG PAGE -->
      <div class="page" id="page-audit">
        <div class="page-title">AUDIT LOG <span>// compliance events</span></div>
        <div class="table-wrap"><table><thead><tr><th>Timestamp</th><th>Event Type</th><th>Actor</th><th>Details</th></tr></thead><tbody id="audit-table"><tr><td colspan="4" class="loading">[LOADING...]</td></tr></tbody></table></div>
      </div>

    </div>
  </div>
</div>

<script>
const API = 'https://api.agentwallet.fun/v1';
let token = localStorage.getItem('aw_token');
let userEmail = localStorage.getItem('aw_email');

// --- Matrix Rain ---
(function initMatrix() {
  const c = document.getElementById('matrix'), ctx = c.getContext('2d');
  function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
  resize(); window.addEventListener('resize', resize);
  const cols = Math.floor(c.width / 14), drops = Array(cols).fill(1);
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%^&*';
  setInterval(() => {
    ctx.fillStyle = 'rgba(10,10,10,.05)'; ctx.fillRect(0, 0, c.width, c.height);
    ctx.fillStyle = '#00ff41'; ctx.font = '13px JetBrains Mono';
    for (let i = 0; i < drops.length; i++) {
      ctx.fillText(chars[Math.floor(Math.random() * chars.length)], i * 14, drops[i] * 14);
      if (drops[i] * 14 > c.height && Math.random() > .975) drops[i] = 0;
      drops[i]++;
    }
  }, 50);
})();

// --- Toast ---
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// --- Fetch Wrapper ---
async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(API + path, { ...opts, headers });
  if (res.status === 401) { logout(); throw new Error('Session expired'); }
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.detail || data.message || `Error ${res.status}`);
  return data;
}

// --- Auth ---
function showAuthTab(tab) {
  document.querySelectorAll('.auth-tabs button').forEach((b, i) => {
    b.classList.toggle('active', (tab === 'login' ? i === 0 : i === 1));
  });
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
}

async function handleLogin(e) {
  e.preventDefault();
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';
  try {
    const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({
      email: document.getElementById('login-email').value,
      password: document.getElementById('login-password').value
    })});
    token = data.access_token;
    userEmail = document.getElementById('login-email').value;
    localStorage.setItem('aw_token', token);
    localStorage.setItem('aw_email', userEmail);
    enterDashboard();
    toast('Authenticated successfully');
  } catch (err) { errEl.textContent = err.message; }
}

async function handleRegister(e) {
  e.preventDefault();
  const errEl = document.getElementById('reg-error');
  errEl.textContent = '';
  try {
    const data = await api('/auth/register', { method: 'POST', body: JSON.stringify({
      org_name: document.getElementById('reg-org').value,
      email: document.getElementById('reg-email').value,
      password: document.getElementById('reg-password').value
    })});
    token = data.access_token;
    userEmail = document.getElementById('reg-email').value;
    localStorage.setItem('aw_token', token);
    localStorage.setItem('aw_email', userEmail);
    enterDashboard();
    toast('Registration successful');
  } catch (err) { errEl.textContent = err.message; }
}

function logout() {
  token = null; userEmail = null;
  localStorage.removeItem('aw_token');
  localStorage.removeItem('aw_email');
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('dashboard').classList.remove('active');
}

function enterDashboard() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.add('active');
  document.getElementById('user-email').textContent = userEmail || '';
  loadPage('overview');
}

// --- Navigation ---
function navigate(page) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
  document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + page));
  document.getElementById('sidebar').classList.remove('open');
  loadPage(page);
}
document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', () => navigate(n.dataset.page)));

// --- Helpers ---
function truncate(s, len = 16) { return s && s.length > len ? s.slice(0, len) + '...' : (s || '--'); }
function fmtDate(d) { if (!d) return '--'; const dt = new Date(d); return dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function statusBadge(s) { return `<span class="status-badge status-${(s||'').toUpperCase()}">${(s||'--').toUpperCase()}</span>`; }
function emptyRow(cols, msg = 'No data') { return `<tr><td colspan="${cols}" style="color:var(--text-dim);text-align:center;padding:20px">${msg}</td></tr>`; }

// --- Page Loaders ---
async function loadPage(page) {
  try {
    switch (page) {
      case 'overview': await loadOverview(); break;
      case 'agents': await loadAgents(); break;
      case 'wallets': await loadWallets(); break;
      case 'transactions': await loadTransactions(); break;
      case 'escrow': await loadEscrows(); break;
      case 'policies': await loadPolicies(); break;
      case 'pda': await loadPDA(); break;
      case 'analytics': await loadAnalytics(); break;
      case 'audit': await loadAudit(); break;
    }
  } catch (err) { toast(err.message, 'error'); }
}

async function loadOverview() {
  const [agents, wallets, txs, escrows] = await Promise.all([
    api('/agents').catch(() => ({ data: [] })),
    api('/wallets').catch(() => ({ data: [] })),
    api('/transactions').catch(() => ({ data: [] })),
    api('/escrow').catch(() => ({ data: [] }))
  ]);
  const ag = agents.data || agents || [];
  const wl = wallets.data || wallets || [];
  const tx = txs.data || txs || [];
  const es = escrows.data || escrows || [];
  document.getElementById('stat-agents').textContent = ag.length;
  document.getElementById('stat-wallets').textContent = wl.length;
  document.getElementById('stat-txs').textContent = tx.length;
  document.getElementById('stat-escrows').textContent = es.length;
  const tbody = document.getElementById('overview-txs');
  if (!tx.length) { tbody.innerHTML = emptyRow(5, 'No transactions yet'); return; }
  tbody.innerHTML = tx.slice(0, 10).map(t => `<tr>
    <td>${t.transaction_type || t.type || '--'}</td>
    <td style="color:var(--cyan)">${t.amount_sol ?? t.amount ?? '--'} SOL</td>
    <td>${statusBadge(t.status)}</td>
    <td title="${t.signature || ''}">${truncate(t.signature || t.tx_signature, 20)}</td>
    <td>${fmtDate(t.created_at)}</td>
  </tr>`).join('');
}

let cachedAgents = [];
async function loadAgents() {
  const data = await api('/agents');
  cachedAgents = data.data || data || [];
  const tbody = document.getElementById('agents-table');
  if (!cachedAgents.length) { tbody.innerHTML = emptyRow(5, 'No agents created'); return; }
  tbody.innerHTML = cachedAgents.map(a => `<tr>
    <td style="color:var(--green)">${a.name}</td>
    <td>${truncate(a.id, 12)}</td>
    <td>${statusBadge(a.status || 'active')}</td>
    <td>${(a.capabilities || []).join(', ') || '--'}</td>
    <td>${fmtDate(a.created_at)}</td>
  </tr>`).join('');
}

async function createAgent(e) {
  e.preventDefault();
  try {
    const caps = document.getElementById('agent-caps').value.split(',').map(s => s.trim()).filter(Boolean);
    await api('/agents', { method: 'POST', body: JSON.stringify({
      name: document.getElementById('agent-name').value,
      description: document.getElementById('agent-desc').value,
      capabilities: caps
    })});
    toast('Agent deployed');
    document.getElementById('agent-name').value = '';
    document.getElementById('agent-desc').value = '';
    document.getElementById('agent-caps').value = '';
    await loadAgents();
  } catch (err) { toast(err.message, 'error'); }
}

let cachedWallets = [];
async function loadWallets() {
  const [wData, aData] = await Promise.all([
    api('/wallets'),
    api('/agents').catch(() => ({ data: [] }))
  ]);
  cachedWallets = wData.data || wData || [];
  cachedAgents = aData.data || aData || [];
  // Populate agent selects
  const selects = ['wallet-agent', 'tx-from-wallet', 'escrow-wallet'];
  selects.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    if (id === 'wallet-agent') {
      sel.innerHTML = cachedAgents.map(a => `<option value="${a.id}">${a.name} (${truncate(a.id,8)})</option>`).join('') || '<option value="">No agents</option>';
    } else {
      sel.innerHTML = cachedWallets.map(w => `<option value="${w.id}">${truncate(w.address,12)} (${w.network})</option>`).join('') || '<option value="">No wallets</option>';
    }
  });
  const tbody = document.getElementById('wallets-table');
  if (!cachedWallets.length) { tbody.innerHTML = emptyRow(6, 'No wallets created'); return; }
  tbody.innerHTML = cachedWallets.map(w => `<tr>
    <td title="${w.address}" style="color:var(--cyan)">${truncate(w.address, 20)}</td>
    <td>${w.network || '--'}</td>
    <td>${truncate(w.agent_id, 10)}</td>
    <td id="bal-${w.id}">--</td>
    <td>${fmtDate(w.created_at)}</td>
    <td><button class="btn small" onclick="checkBalance('${w.id}')">Balance</button></td>
  </tr>`).join('');
}

async function createWallet(e) {
  e.preventDefault();
  try {
    await api('/wallets', { method: 'POST', body: JSON.stringify({
      agent_id: document.getElementById('wallet-agent').value,
      network: document.getElementById('wallet-network').value
    })});
    toast('Wallet created');
    await loadWallets();
  } catch (err) { toast(err.message, 'error'); }
}

async function checkBalance(id) {
  const el = document.getElementById('bal-' + id);
  el.textContent = '...';
  try {
    const data = await api(`/wallets/${id}/balance`);
    el.innerHTML = `<span style="color:var(--green)">${data.sol_balance ?? '--'} SOL</span>`;
  } catch (err) { el.textContent = 'error'; toast(err.message, 'error'); }
}

async function loadTransactions() {
  await populateWalletSelects();
  const data = await api('/transactions');
  const txs = data.data || data || [];
  const tbody = document.getElementById('txs-table');
  if (!txs.length) { tbody.innerHTML = emptyRow(6, 'No transactions'); return; }
  tbody.innerHTML = txs.map(t => `<tr>
    <td>${t.transaction_type || t.type || '--'}</td>
    <td style="color:var(--cyan)">${t.amount_sol ?? t.amount ?? '--'} SOL</td>
    <td>${statusBadge(t.status)}</td>
    <td title="${t.signature || t.tx_signature || ''}">${truncate(t.signature || t.tx_signature, 18)}</td>
    <td>${truncate(t.from_address || t.from_wallet_id, 14)}</td>
    <td>${fmtDate(t.created_at)}</td>
  </tr>`).join('');
}

async function sendSol(e) {
  e.preventDefault();
  try {
    await api('/transactions/transfer-sol', { method: 'POST', body: JSON.stringify({
      from_wallet_id: document.getElementById('tx-from-wallet').value,
      to_address: document.getElementById('tx-to').value,
      amount_sol: parseFloat(document.getElementById('tx-amount').value)
    })});
    toast('Transfer submitted');
    document.getElementById('tx-to').value = '';
    document.getElementById('tx-amount').value = '';
    await loadTransactions();
  } catch (err) { toast(err.message, 'error'); }
}

async function loadEscrows() {
  await populateWalletSelects();
  const data = await api('/escrow');
  const rows = data.data || data || [];
  const tbody = document.getElementById('escrow-table');
  if (!rows.length) { tbody.innerHTML = emptyRow(6, 'No escrows'); return; }
  tbody.innerHTML = rows.map(e => {
    const canAct = ['CREATED','FUNDED','created','funded'].includes(e.status);
    return `<tr>
      <td>${truncate(e.id, 12)}</td>
      <td style="color:var(--cyan)">${e.amount_sol ?? e.amount ?? '--'} SOL</td>
      <td>${statusBadge(e.status)}</td>
      <td>${truncate(e.recipient_address || e.recipient, 16)}</td>
      <td>${fmtDate(e.expires_at)}</td>
      <td>${canAct ? `<button class="btn small" onclick="escrowAction('${e.id}','release')">Release</button> <button class="btn small orange" onclick="escrowAction('${e.id}','refund')">Refund</button>` : '--'}</td>
    </tr>`;
  }).join('');
}

async function createEscrow(e) {
  e.preventDefault();
  try {
    await api('/escrow', { method: 'POST', body: JSON.stringify({
      funder_wallet_id: document.getElementById('escrow-wallet').value,
      recipient_address: document.getElementById('escrow-recipient').value,
      amount_sol: parseFloat(document.getElementById('escrow-amount').value),
      expires_in_hours: parseInt(document.getElementById('escrow-hours').value)
    })});
    toast('Escrow created');
    document.getElementById('escrow-recipient').value = '';
    document.getElementById('escrow-amount').value = '';
    await loadEscrows();
  } catch (err) { toast(err.message, 'error'); }
}

async function escrowAction(id, action) {
  try {
    await api(`/escrow/${id}/action`, { method: 'POST', body: JSON.stringify({ action }) });
    toast(`Escrow ${action} successful`);
    await loadEscrows();
  } catch (err) { toast(err.message, 'error'); }
}

async function loadPolicies() {
  const data = await api('/policies');
  const rows = data.data || data || [];
  const tbody = document.getElementById('policies-table');
  if (!rows.length) { tbody.innerHTML = emptyRow(6, 'No policies'); return; }
  tbody.innerHTML = rows.map(p => `<tr>
    <td style="color:var(--orange)">${p.name}</td>
    <td>${p.scope_type || '--'}</td>
    <td>${truncate(p.scope_id, 12)}</td>
    <td>${p.enabled !== false ? '<span style="color:var(--green)">YES</span>' : '<span style="color:var(--magenta)">NO</span>'}</td>
    <td title='${JSON.stringify(p.rules || {})}'>${truncate(JSON.stringify(p.rules || {}), 30)}</td>
    <td>${fmtDate(p.created_at)}</td>
  </tr>`).join('');
}

async function createPolicy(e) {
  e.preventDefault();
  try {
    let rules = {};
    try { rules = JSON.parse(document.getElementById('policy-rules').value || '{}'); } catch { throw new Error('Invalid JSON in rules'); }
    await api('/policies', { method: 'POST', body: JSON.stringify({
      name: document.getElementById('policy-name').value,
      rules,
      scope_type: document.getElementById('policy-scope').value,
      scope_id: document.getElementById('policy-sid').value
    })});
    toast('Policy created');
    document.getElementById('policy-name').value = '';
    document.getElementById('policy-sid').value = '';
    document.getElementById('policy-rules').value = '';
    await loadPolicies();
  } catch (err) { toast(err.message, 'error'); }
}

async function loadPDA() {
  if (!cachedAgents.length) { try { const a = await api('/agents'); cachedAgents = a.data || a || []; } catch {} }
  const sel = document.getElementById('pda-agent');
  if (sel) sel.innerHTML = cachedAgents.map(a => '<option value="'+a.id+'">'+a.name+' ('+truncate(a.id,8)+')</option>').join('') || '<option value="">No agents</option>';
  try {
    const data = await api('/pda-wallets');
    const rows = data.data || data || [];
    const tbody = document.getElementById('pda-table');
    if (!rows.length) { tbody.innerHTML = emptyRow(6, 'No PDA wallets — deploy one above'); return; }
    tbody.innerHTML = rows.map(p => '<tr><td title="'+(p.pda_address||'')+'" style="color:var(--purple)">'+truncate(p.pda_address||p.address,18)+'</td><td>'+truncate(p.agent_id,10)+'</td><td style="color:var(--cyan)">'+(p.daily_limit_sol||'--')+' SOL</td><td style="color:var(--yellow)">'+(p.per_tx_limit_sol||'--')+' SOL</td><td>'+(p.is_active!==false?'<span style="color:var(--green)">ACTIVE</span>':'<span style="color:var(--magenta)">PAUSED</span>')+'</td><td>'+fmtDate(p.created_at)+'</td></tr>').join('');
  } catch (err) { document.getElementById('pda-table').innerHTML = emptyRow(6, err.message); }
}
async function createPDA(e) {
  e.preventDefault();
  try {
    await api('/pda-wallets', { method: 'POST', body: JSON.stringify({
      agent_id: document.getElementById('pda-agent').value,
      daily_limit_sol: parseFloat(document.getElementById('pda-daily').value),
      per_tx_limit_sol: parseFloat(document.getElementById('pda-pertx').value)
    })});
    toast('PDA Wallet deployed on-chain!');
    await loadPDA();
  } catch (err) { toast(err.message, 'error'); }
}

async function loadAnalytics() {
  const grid = document.getElementById('analytics-grid');
  try {
    const data = await api('/analytics/summary');
    const entries = Object.entries(data).filter(([k]) => k !== 'detail');
    if (!entries.length) { grid.innerHTML = '<div class="stat-card"><div class="label">Status</div><div class="value" style="font-size:1rem">No analytics data available</div></div>'; return; }
    const colors = ['', 'cyan', 'purple', 'yellow'];
    grid.innerHTML = entries.map(([k, v], i) => `<div class="stat-card">
      <div class="label">${k.replace(/_/g, ' ')}</div>
      <div class="value ${colors[i % 4]}">${typeof v === 'object' ? JSON.stringify(v) : v}</div>
    </div>`).join('');
  } catch (err) {
    grid.innerHTML = `<div class="stat-card"><div class="label">Error</div><div class="value" style="font-size:.9rem;color:var(--magenta)">${err.message}</div></div>`;
  }
}

async function loadAudit() {
  const tbody = document.getElementById('audit-table');
  try {
    const data = await api('/compliance/audit-log');
    const rows = data.data || data || [];
    if (!rows.length) { tbody.innerHTML = emptyRow(4, 'No audit events'); return; }
    tbody.innerHTML = rows.map(e => `<tr>
      <td>${fmtDate(e.timestamp || e.created_at)}</td>
      <td style="color:var(--yellow)">${e.event_type || e.action || '--'}</td>
      <td>${e.actor || e.actor_id || e.user_id || '--'}</td>
      <td title='${JSON.stringify(e.details || e.metadata || {})}'>${truncate(JSON.stringify(e.details || e.metadata || {}), 40)}</td>
    </tr>`).join('');
  } catch (err) { tbody.innerHTML = emptyRow(4, err.message); }
}

async function populateWalletSelects() {
  if (cachedWallets.length) return;
  try {
    const [wData, aData] = await Promise.all([api('/wallets'), api('/agents').catch(() => ({ data: [] }))]);
    cachedWallets = wData.data || wData || [];
    cachedAgents = aData.data || aData || [];
  } catch {}
  ['tx-from-wallet', 'escrow-wallet'].forEach(id => {
    const sel = document.getElementById(id);
    if (sel && sel.options.length <= 1) {
      sel.innerHTML = cachedWallets.map(w => `<option value="${w.id}">${truncate(w.address,12)} (${w.network})</option>`).join('') || '<option value="">No wallets</option>';
    }
  });
}

// --- Init ---
if (token) { enterDashboard(); } else { document.getElementById('auth-screen').classList.remove('hidden'); }

// --- Quest verification: mark try-dashboard quest on login ---
(function(){
  try{
    var qsb=window.supabase;
    if(!qsb)return;
    var sb2=qsb.createClient('https://rlajsbxsculwamkpgsmm.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsYWpzYnhzY3Vsd2Fta3Bnc21tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5NDUwNTUsImV4cCI6MjA4NjUyMTA1NX0.3C0AxpkvFBfGsbYZQYHDE25DY4UgVPMur4c6zK5Lu7A');
    sb2.auth.getSession().then(function(r){
      if(r.data.session){
        sb2.from('quest_verifications').upsert({user_id:r.data.session.user.id,quest_id:'try-dashboard',verification_data:{dashboard_login:true,timestamp:new Date().toISOString()}},{onConflict:'user_id,quest_id'}).then(function(){});
      }
    });
  }catch(e){}
})();
</script>
<script>
// ── PARTICLES ──
const pc2=document.getElementById('particles'),px2=pc2.getContext('2d');
function resP2(){pc2.width=innerWidth;pc2.height=innerHeight}resP2();addEventListener('resize',resP2);
const pts2=[];for(let i=0;i<60;i++)pts2.push({x:Math.random()*pc2.width,y:Math.random()*pc2.height,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,r:Math.random()*1.5+.5});
function drawP2(){px2.clearRect(0,0,pc2.width,pc2.height);for(let i=0;i<pts2.length;i++){const p=pts2[i];p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=pc2.width;if(p.x>pc2.width)p.x=0;if(p.y<0)p.y=pc2.height;if(p.y>pc2.height)p.y=0;px2.beginPath();px2.arc(p.x,p.y,p.r,0,Math.PI*2);px2.fillStyle='rgba(0,255,65,0.5)';px2.fill();for(let j=i+1;j<pts2.length;j++){const q=pts2[j],dx=p.x-q.x,dy=p.y-q.y,d=Math.sqrt(dx*dx+dy*dy);if(d<120){px2.beginPath();px2.moveTo(p.x,p.y);px2.lineTo(q.x,q.y);px2.strokeStyle='rgba(0,255,65,'+(1-d/120)*.1+')';px2.lineWidth=.5;px2.stroke()}}}requestAnimationFrame(drawP2)}drawP2();

// ── SCROLL PROGRESS ──
addEventListener('scroll',()=>{const h=document.documentElement.scrollHeight-innerHeight;if(h>0)document.getElementById('scroll-prog').style.width=(scrollY/h*100)+'%'});

// ── BOOT SEQUENCE ──
(async function(){
  const lines=document.querySelectorAll('.boot-line');
  for(let i=0;i<lines.length;i++){
    await new Promise(r=>setTimeout(r,200+Math.random()*300));
    lines[i].classList.add('visible');
  }
  await new Promise(r=>setTimeout(r,600));
  document.getElementById('boot-overlay').classList.add('done');
})();

// ── RANDOM GLITCH ──
setInterval(()=>{
  const els=document.querySelectorAll('.page-title,.stat-card .label,.nav-item.active,.logo');
  if(!els.length)return;
  const el=els[Math.floor(Math.random()*els.length)];
  el.style.animation='none';el.offsetHeight;
  el.style.animation='tGlitch .15s linear';
  setTimeout(()=>{el.style.animation=''},150);
},3000+Math.random()*4000);

// ── HOVER GLOW ──
document.querySelectorAll('.stat-card,.btn,.nav-item,.form-card').forEach(el=>{
  el.addEventListener('mouseenter',()=>{el.style.textShadow='0 0 12px rgba(0,255,65,.3)'});
  el.addEventListener('mouseleave',()=>{el.style.textShadow=''});
});
</script>
</body>
</html>
